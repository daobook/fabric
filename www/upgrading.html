
<!DOCTYPE html>

<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Upgrading from 1.x &#8212; Fabric  文档</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/translations.js"></script>
    <link rel="index" title="索引" href="genindex.html" />
    <link rel="search" title="搜索" href="search.html" />
    <link rel="next" title="Development" href="development.html" />
    <link rel="prev" title="Installing (1.x)" href="installing-1.x.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="upgrading-from-1-x">
<span id="upgrading"></span><h1>Upgrading from 1.x<a class="headerlink" href="#upgrading-from-1-x" title="Permalink to this heading">¶</a></h1>
<p>Modern Fabric (2+) represents a near-total reimplementation &amp; reorganization of
the software. It’s been <span class="xref std std-ref">broken in two</span>,
cleaned up, made more explicit, and so forth. In some cases, upgrading requires
only basic search &amp; replace; in others, more work is needed.</p>
<p>If you read this document carefully, it should guide you in the right direction
until you’re fully upgraded. If any functionality you’re using in Fabric 1
isn’t listed here, please file a ticket <a class="reference external" href="https://github.com/fabric/fabric">on Github</a> and we’ll update it ASAP.</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>As of the 2.0 release line, Fabric 2 is <strong>not</strong> at 100% feature parity with
1.x! Some features have been explicitly dropped, but others simply have not
been ported over yet, either due to time constraints or because said
features need to be re-examined in a modern context.</p>
<p>Please review the information below, including the <a class="reference internal" href="#upgrade-specifics"><span class="std std-ref">Upgrade specifics</span></a>
section which contains a very detailed list, before filing bug reports!</p>
<p>Also see <a class="reference internal" href="roadmap.html#roadmap"><span class="std std-ref">the roadmap</span></a> for additional notes about release
versioning.</p>
</div>
<section id="why-upgrade">
<h2>Why upgrade?<a class="headerlink" href="#why-upgrade" title="Permalink to this heading">¶</a></h2>
<p>We’d like to call out, in no particular order, some specific improvements in
modern Fabric that might make upgrading worth your time.</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>These are all listed in the rest of the doc too, so if you’re already sold,
just skip there.</p>
</div>
<ul class="simple">
<li><p>Python 3 compatibility (specifically, we now support 2.7 and 3.4+);</p></li>
<li><p>Thread-safe - no more requirement on multiprocessing for concurrency;</p></li>
<li><p>API reorganized around <code class="xref py py-obj docutils literal notranslate"><span class="pre">fabric.connection.Connection</span></code> objects instead of
global module state;</p></li>
<li><p>Command-line parser overhauled to allow for regular GNU/POSIX style flags and
options on a per-task basis (no more <code class="docutils literal notranslate"><span class="pre">fab</span> <span class="pre">mytask:weird=custom,arg=format</span></code>);</p></li>
<li><p>Task organization is more explicit and flexible / has less ‘magic’;</p></li>
<li><p>Tasks can declare other tasks to always be run before or after themselves;</p></li>
<li><p>Configuration massively expanded to allow for multiple config files &amp;
formats, env vars, per-user/project/module configs, and much more;</p></li>
<li><p>SSH config file loading enabled by default &amp; has been fleshed out re:
system/user/runtime file selection;</p></li>
<li><p>Shell command execution API consistent across local and remote method calls -
no more differentiation between <code class="docutils literal notranslate"><span class="pre">local</span></code> and <code class="docutils literal notranslate"><span class="pre">run</span></code> (besides where the
command runs, of course!);</p></li>
<li><p>Shell commands significantly more flexible re: interactive behavior,
simultaneous capture &amp; display (now applies to local subprocesses, not just
remote), encoding control, and auto-responding;</p></li>
<li><p>Use of Paramiko’s APIs for the SSH layer much more transparent - e.g.
<code class="xref py py-obj docutils literal notranslate"><span class="pre">fabric.connection.Connection</span></code> allows control over the kwargs given to
<code class="xref py py-obj docutils literal notranslate"><span class="pre">SSHClient.connect</span></code>;</p></li>
<li><p>Gateway/jump-host functionality offers a <code class="docutils literal notranslate"><span class="pre">ProxyJump</span></code> style ‘native’ (no
proxy-command subprocesses) option, which can be nested infinitely;</p></li>
</ul>
</section>
<section id="sidegrading-to-invoke">
<h2>‘Sidegrading’ to Invoke<a class="headerlink" href="#sidegrading-to-invoke" title="Permalink to this heading">¶</a></h2>
<p>We linked to a note about this above, but to be explicit: modern Fabric is
really a few separate libraries, and anything not strictly SSH or network
related has been <span class="xref std std-ref">split out into the Invoke project</span>.</p>
<p>This means that if you’re in the group of users leveraging Fabric solely for
its task execution or <code class="docutils literal notranslate"><span class="pre">local</span></code>, and never used <code class="docutils literal notranslate"><span class="pre">run</span></code>, <code class="docutils literal notranslate"><span class="pre">put</span></code> or
similar - <strong>you don’t need to use Fabric itself anymore</strong> and can simply
<strong>‘sidegrade’ to Invoke instead</strong>.</p>
<p>You’ll still want to read over this document to get a sense of how things have
changed, but be aware that you can get away with <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">invoke</span></code> and
won’t need Fabric, Paramiko, cryptography dependencies, or anything else.</p>
</section>
<section id="using-modern-fabric-from-within-invoke">
<h2>Using modern Fabric from within Invoke<a class="headerlink" href="#using-modern-fabric-from-within-invoke" title="Permalink to this heading">¶</a></h2>
<p>We intend to enhance modern Fabric until it encompasses the bulk of Fabric 1’s
use cases, such that you can use <code class="docutils literal notranslate"><span class="pre">fab</span></code> and fabfiles on their own without
caring too much about how it’s built on top of Invoke.</p>
<p>However, prior to that point – and very useful on its own for
intermediate-to-advanced users – is the fact that modern Fabric is
designed with library or direct API use in mind. <strong>It’s entirely possible, and
in some cases preferable, to use Invoke for your CLI needs and Fabric as a pure
API within your Invoke tasks.</strong></p>
<p>In other words, you can eschew <code class="docutils literal notranslate"><span class="pre">fab</span></code>/fabfiles entirely unless you find
yourself strongly needing the conveniences it wraps around ad-hoc sessions,
such as <code class="xref std std-option docutils literal notranslate"><span class="pre">--hosts</span></code> and the like.</p>
</section>
<section id="running-both-fabric-versions-simultaneously">
<h2>Running both Fabric versions simultaneously<a class="headerlink" href="#running-both-fabric-versions-simultaneously" title="Permalink to this heading">¶</a></h2>
<p>To help with gradual upgrades, modern Fabric may be installed under the name
<code class="docutils literal notranslate"><span class="pre">fabric2</span></code> (in addition to being made available “normally” as versions 2.0+ of
<code class="docutils literal notranslate"><span class="pre">fabric</span></code>) and can live alongside installations of version 1.x.</p>
<p>Thus, if you have a large codebase and don’t want to make the jump to modern
versions in one leap, it’s possible to have both Fabric 1 (<code class="docutils literal notranslate"><span class="pre">fabric</span></code>, as you
presumably had it installed previously) and modern Fabric (as <code class="docutils literal notranslate"><span class="pre">fabric2</span></code>)
resident in your Python environment simultaneously.</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>We strongly recommend that you eventually migrate all code using Fabric 1,
to versions 2 or above, so that you can move back to installing and
importing under the <code class="docutils literal notranslate"><span class="pre">fabric</span></code> name. <code class="docutils literal notranslate"><span class="pre">fabric2</span></code> as a distinct package and
module is intended to be a stopgap, and there will not be any <code class="docutils literal notranslate"><span class="pre">fabric3</span></code>
or above (not least because some of those names are already taken!)</p>
</div>
<p>For details on how to obtain the <code class="docutils literal notranslate"><span class="pre">fabric2</span></code> version of the package, see
<a class="reference internal" href="installing.html#installing-as-fabric2"><span class="std std-ref">Installing modern Fabric as fabric2</span></a>.</p>
<section id="creating-connection-and-or-config-objects-from-v1-settings">
<span id="from-v1"></span><h3>Creating <code class="docutils literal notranslate"><span class="pre">Connection</span></code> and/or <code class="docutils literal notranslate"><span class="pre">Config</span></code> objects from v1 settings<a class="headerlink" href="#creating-connection-and-or-config-objects-from-v1-settings" title="Permalink to this heading">¶</a></h3>
<p>A common tactic when upgrading piecemeal is to generate modern Fabric objects
whose contents match the current Fabric 1 environment. Whereas Fabric 1 stores
<em>all</em> configuration (including the “current host”) in a single place – the
<code class="docutils literal notranslate"><span class="pre">env</span></code> object – modern Fabric breaks things up into multiple (albeit
composed) objects: <code class="xref py py-obj docutils literal notranslate"><span class="pre">Connection</span></code> for per-connection
parameters, and <code class="xref py py-obj docutils literal notranslate"><span class="pre">Config</span></code> for general settings and defaults.</p>
<p>In most cases, you’ll only need to generate a <code class="xref py py-obj docutils literal notranslate"><span class="pre">Connection</span></code>
object using the alternate class constructor <code class="xref py py-obj docutils literal notranslate"><span class="pre">Connection.from_v1</span></code>, which should be fed your appropriate
local <code class="docutils literal notranslate"><span class="pre">fabric.api.env</span></code> object; see its API docs for details.</p>
<p>A contrived example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">fabric.api</span> <span class="kn">import</span> <span class="n">env</span><span class="p">,</span> <span class="n">run</span>
<span class="kn">from</span> <span class="nn">fabric2</span> <span class="kn">import</span> <span class="n">Connection</span>

<span class="n">env</span><span class="o">.</span><span class="n">host_string</span> <span class="o">=</span> <span class="s2">&quot;admin@myserver&quot;</span>
<span class="n">run</span><span class="p">(</span><span class="s2">&quot;whoami&quot;</span><span class="p">)</span> <span class="c1"># v1</span>
<span class="n">cxn</span> <span class="o">=</span> <span class="n">Connection</span><span class="o">.</span><span class="n">from_v1</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
<span class="n">cxn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;whoami&quot;</span><span class="p">)</span> <span class="c1"># v2+</span>
</pre></div>
</div>
<p>By default, this constructor calls another API member – <code class="xref py py-obj docutils literal notranslate"><span class="pre">Config.from_v1</span></code> – internally on your behalf. Users who need
tighter control over modern-style config options may opt to call that
classmethod explicitly and hand their modified result into <code class="xref py py-obj docutils literal notranslate"><span class="pre">Connection.from_v1</span></code>, which will cause the latter to skip
any implicit config creation.</p>
</section>
<section id="mapping-of-v1-env-vars-to-modern-api-members">
<span id="v1-env-var-imports"></span><h3>Mapping of v1 <code class="docutils literal notranslate"><span class="pre">env</span></code> vars to modern API members<a class="headerlink" href="#mapping-of-v1-env-vars-to-modern-api-members" title="Permalink to this heading">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">env</span></code> vars and how they map to <code class="xref py py-obj docutils literal notranslate"><span class="pre">Connection</span></code> arguments
or <code class="xref py py-obj docutils literal notranslate"><span class="pre">Config</span></code> values (when fed into the <code class="docutils literal notranslate"><span class="pre">.from_v1</span></code> constructors
described above) are listed below.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>v1 <code class="docutils literal notranslate"><span class="pre">env</span></code> var</p></th>
<th class="head"><p>v2+ usage (prefixed with the class it ends up in)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">always_use_pty</span></code></p></td>
<td><p>Config: <code class="docutils literal notranslate"><span class="pre">run.pty</span></code>.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">command_timeout</span></code></p></td>
<td><p>Config: <code class="docutils literal notranslate"><span class="pre">timeouts.command</span></code>; timeouts are now their own config
subtree, whereas in v1 it was possible for the ambiguous <code class="docutils literal notranslate"><span class="pre">timeout</span></code>
setting – see below – to work for either connect OR command timeouts.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">forward_agent</span></code></p></td>
<td><p>Config: <code class="docutils literal notranslate"><span class="pre">connect_kwargs.forward_agent</span></code>.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">gateway</span></code></p></td>
<td><p>Config: <code class="docutils literal notranslate"><span class="pre">gateway</span></code>.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">host_string</span></code></p></td>
<td><p>Connection: <code class="docutils literal notranslate"><span class="pre">host</span></code> kwarg (which can handle host-string like values,
including user/port).</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">key</span></code></p></td>
<td><p><strong>Not supported</strong>: Fabric 1 performed extra processing on this
(trying a bunch of key classes to instantiate) before
handing it into Paramiko; modern Fabric prefers to just let you handle
Paramiko-level parameters directly.</p>
<p>If you’re filling your Fabric 1 <code class="docutils literal notranslate"><span class="pre">key</span></code> data from a file, we recommend
switching to <code class="docutils literal notranslate"><span class="pre">key_filename</span></code> instead, which is supported.</p>
<p>If you’re loading key data from some other source as a string, you
should know what type of key your data is and manually instantiate it
instead, then supply it to the <code class="docutils literal notranslate"><span class="pre">connect_kwargs</span></code> parameter. For
example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>  <span class="c1"># or &#39;from StringIO&#39; on Python 2</span>
<span class="kn">from</span> <span class="nn">fabric.state</span> <span class="kn">import</span> <span class="n">env</span>
<span class="kn">from</span> <span class="nn">fabric2</span> <span class="kn">import</span> <span class="n">Connection</span>
<span class="kn">from</span> <span class="nn">paramiko</span> <span class="kn">import</span> <span class="n">RSAKey</span>
<span class="kn">from</span> <span class="nn">somewhere</span> <span class="kn">import</span> <span class="n">load_my_key_string</span>

<span class="n">pkey</span> <span class="o">=</span> <span class="n">RSAKey</span><span class="o">.</span><span class="n">from_private_key</span><span class="p">(</span><span class="n">StringIO</span><span class="p">(</span><span class="n">load_my_key_string</span><span class="p">()))</span>
<span class="n">cxn</span> <span class="o">=</span> <span class="n">Connection</span><span class="o">.</span><span class="n">from_v1</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">connect_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pkey&quot;</span><span class="p">:</span> <span class="n">pkey</span><span class="p">})</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">key_filename</span></code></p></td>
<td><p>Config: <code class="docutils literal notranslate"><span class="pre">connect_kwargs.key_filename</span></code>.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">no_agent</span></code></p></td>
<td><p>Config: <code class="docutils literal notranslate"><span class="pre">connect_kwargs.allow_agent</span></code> (inverted).</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">password</span></code></p></td>
<td><p>Config: <code class="docutils literal notranslate"><span class="pre">connect_kwargs.password</span></code>, as well as <code class="docutils literal notranslate"><span class="pre">sudo.password</span></code>
<strong>if and only if</strong> the env’s <code class="docutils literal notranslate"><span class="pre">sudo_password</span></code> (see below) is unset.
(This mimics how v1 uses this particular setting - in earlier versions
there was no <code class="docutils literal notranslate"><span class="pre">sudo_password</span></code> at all.)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">port</span></code></p></td>
<td><p>Connection: <code class="docutils literal notranslate"><span class="pre">port</span></code> kwarg. Is casted to an integer due to Fabric 1’s
default being a string value (which is not valid in v2).</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>Since v1’s <code class="docutils literal notranslate"><span class="pre">port</span></code> is used both for a default <em>and</em> to store the
current connection state, v2 uses it to fill in the Connection
only, and not the Config, on assumption that it will typically be
the current connection state.</p>
</div>
</td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">ssh_config_path</span></code></p></td>
<td><p>Config: <code class="docutils literal notranslate"><span class="pre">ssh_config_path</span></code>.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">sudo_password</span></code></p></td>
<td><p>Config: <code class="docutils literal notranslate"><span class="pre">sudo.password</span></code>.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">sudo_prompt</span></code></p></td>
<td><p>Config: <code class="docutils literal notranslate"><span class="pre">sudo.prompt</span></code>.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">timeout</span></code></p></td>
<td><p>Config: <code class="docutils literal notranslate"><span class="pre">timeouts.connection</span></code>, for connection timeouts, or
<code class="docutils literal notranslate"><span class="pre">timeouts.command</span></code> for command timeouts (see above).</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">use_ssh_config</span></code></p></td>
<td><p>Config: <code class="docutils literal notranslate"><span class="pre">load_ssh_configs</span></code>.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">user</span></code></p></td>
<td><p>Connection: <code class="docutils literal notranslate"><span class="pre">user</span></code> kwarg.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">warn_only</span></code></p></td>
<td><p>Config: <code class="docutils literal notranslate"><span class="pre">run.warn</span></code></p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="upgrade-specifics">
<span id="id1"></span><h2>Upgrade specifics<a class="headerlink" href="#upgrade-specifics" title="Permalink to this heading">¶</a></h2>
<p>This is (intended to be) an exhaustive list of <em>all</em> Fabric 1.x functionality,
as well as new-to-Invoke-or-Fabric-2 functionality not present in 1.x; it
specifies whether upgrading is necessary, how to upgrade if so, and tracks
features which haven’t been implemented in modern versions yet.</p>
<p>Most sections are broken down in table form, as follows:</p>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Fabric 1 feature or behavior</p></td>
<td><p>Status, see below for breakdown</p></td>
<td><p>Migration notes, removal rationale, etc</p></td>
</tr>
</tbody>
</table>
<p>Below are the typical values for the ‘status’ column, though some of them are a
bit loose - make sure to read the notes column in all cases! Also note that
things are not ironclad - eg any ‘removed’ item has some chance of returning if
enough users request it or use cases are made that workarounds are
insufficient.</p>
<ul class="simple">
<li><p><strong>Ported</strong>: available already, possibly renamed or moved (frequently, moved
into the <a class="reference external" href="https://pyinvoke.org">Invoke</a> codebase.)</p></li>
<li><p><strong>Pending</strong>: would fit, but has not yet been ported, good candidate for a
patch. <em>These entries link to the appropriate Github ticket</em> - please do
not make new ones!</p></li>
<li><p><strong>Removed</strong>: explicitly <em>not</em> ported (no longer fits with vision, had too
poor a maintenance-to-value ratio, etc) and unlikely to be reinstated.</p></li>
</ul>
<p>Here’s a quick local table of contents for navigation purposes:</p>
<nav class="contents local" id="id2">
<ul class="simple">
<li><p><a class="reference internal" href="#general-conceptual" id="id5">General / conceptual</a></p></li>
<li><p><a class="reference internal" href="#api-organization" id="id6">API organization</a></p></li>
<li><p><a class="reference internal" href="#task-functions-decorators" id="id7">Task functions &amp; decorators</a></p></li>
<li><p><a class="reference internal" href="#cli-arguments-options-and-behavior" id="id8">CLI arguments, options and behavior</a></p></li>
<li><p><a class="reference internal" href="#shell-command-execution-local-run-sudo" id="id9">Shell command execution (<code class="docutils literal notranslate"><span class="pre">local</span></code>/<code class="docutils literal notranslate"><span class="pre">run</span></code>/<code class="docutils literal notranslate"><span class="pre">sudo</span></code>)</a></p>
<ul>
<li><p><a class="reference internal" href="#general" id="id10">General</a></p></li>
<li><p><a class="reference internal" href="#run" id="id11"><code class="docutils literal notranslate"><span class="pre">run</span></code></a></p></li>
<li><p><a class="reference internal" href="#sudo" id="id12"><code class="docutils literal notranslate"><span class="pre">sudo</span></code></a></p></li>
<li><p><a class="reference internal" href="#local" id="id13"><code class="docutils literal notranslate"><span class="pre">local</span></code></a></p></li>
<li><p><a class="reference internal" href="#open-shell" id="id14"><code class="docutils literal notranslate"><span class="pre">open_shell</span></code></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#utilities" id="id15">Utilities</a></p></li>
<li><p><a class="reference internal" href="#networking" id="id16">Networking</a></p></li>
<li><p><a class="reference internal" href="#authentication" id="id17">Authentication</a></p></li>
<li><p><a class="reference internal" href="#file-transfer" id="id18">File transfer</a></p></li>
<li><p><a class="reference internal" href="#configuration" id="id19">Configuration</a></p></li>
<li><p><a class="reference internal" href="#contrib" id="id20"><code class="docutils literal notranslate"><span class="pre">contrib</span></code></a></p></li>
<li><p><a class="reference internal" href="#fabric-env-reference" id="id21"><code class="docutils literal notranslate"><span class="pre">fabric.env</span></code> reference</a></p></li>
</ul>
</nav>
<section id="general-conceptual">
<span id="upgrading-general"></span><h3><a class="toc-backref" href="#id5" role="doc-backlink">General / conceptual</a><a class="headerlink" href="#general-conceptual" title="Permalink to this heading">¶</a></h3>
<ul>
<li><p>Modern Fabric is fully Python 3 compatible; as a cost, Python 2.5 support (a
longstanding feature of Fabric 1) has been dropped - in fact, we’ve dropped
support for anything older than Python 2.7.</p></li>
<li><p>The CLI task-oriented workflow remains a primary design goal, but the library
use case is no longer a second-class citizen; instead, the library
functionality has been designed first, with the CLI/task features built on
top of it.</p></li>
<li><p>Additionally, within the CLI use case, version 1 placed too much emphasis on
‘lazy’ interactive prompts for authentication secrets or even connection
parameters, driven in part by a lack of strong configuration mechanisms. Over
time it became clear this wasn’t worth the tradeoffs of having confusing
noninteractive behavior and difficult debugging/testing procedures.</p>
<p>Modern Fabric takes an arguably cleaner approach (based on functionality
added to v1 over time) where users are encouraged to leverage the
configuration system and/or serve the user prompts for runtime secrets at the
<em>start</em> of the process; if the system determines it’s missing information
partway through, it raises exceptions instead of prompting.</p>
</li>
<li><p>Invoke’s design includes <span class="xref std std-ref">explicit user-facing testing functionality</span>; if you didn’t find a way to write tests for your
Fabric-using code before, it should be much easier now.</p>
<blockquote>
<div><ul class="simple">
<li><p>We recommend trying to write tests early on; they will help clarify the
upgrade process for you &amp; also make the process safer!</p></li>
</ul>
</div></blockquote>
</li>
</ul>
</section>
<section id="api-organization">
<span id="upgrading-api"></span><h3><a class="toc-backref" href="#id6" role="doc-backlink">API organization</a><a class="headerlink" href="#api-organization" title="Permalink to this heading">¶</a></h3>
<p>High level code flow and API member concerns.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 40%" />
<col style="width: 10%" />
<col style="width: 50%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>Import everything via <code class="docutils literal notranslate"><span class="pre">fabric.api</span></code></p></td>
<td><p>Removed</p></td>
<td><p>All useful imports are now available at the top level, e.g. <code class="docutils literal notranslate"><span class="pre">from</span>
<span class="pre">fabric</span> <span class="pre">import</span> <span class="pre">Connection</span></code>.</p></td>
</tr>
<tr class="row-even"><td><p>Configure connection parameters globally (via <code class="docutils literal notranslate"><span class="pre">env.host_string</span></code>,
<code class="docutils literal notranslate"><span class="pre">env.host</span></code>, <code class="docutils literal notranslate"><span class="pre">env.port</span></code>, <code class="docutils literal notranslate"><span class="pre">env.user</span></code>) and call global methods which
implicitly reference them (<code class="docutils literal notranslate"><span class="pre">run</span></code>/<code class="docutils literal notranslate"><span class="pre">sudo</span></code>/etc)</p></td>
<td><p>Removed</p></td>
<td><p>The primary API is now properly OOP: instantiate
<code class="xref py py-obj docutils literal notranslate"><span class="pre">fabric.connection.Connection</span></code> objects and call their methods. These
objects encapsulate all connection state (user, host, gateway, etc) and
have their own SSH client instances.</p>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><code class="xref py py-obj docutils literal notranslate"><span class="pre">Connection.from_v1</span></code></p>
</div>
</td>
</tr>
<tr class="row-odd"><td><p>Emphasis on serialized “host strings” as method of setting user, host,
port, etc</p></td>
<td><p>Ported/Removed</p></td>
<td><p><code class="xref py py-obj docutils literal notranslate"><span class="pre">fabric.connection.Connection</span></code> <em>can</em> accept a shorthand “host
string”-like argument, but the primary API is now explicit user, host,
port, etc keyword arguments.</p>
<p>Additionally, many arguments/settings/etc that expected a host string
in v1 will now expect a <code class="xref py py-obj docutils literal notranslate"><span class="pre">fabric.connection.Connection</span></code> instance instead.</p>
</td>
</tr>
<tr class="row-even"><td><p>Use of “roles” as global named lists of host strings</p></td>
<td><p>Ported</p></td>
<td><p>This need is now served by <code class="xref py py-obj docutils literal notranslate"><span class="pre">fabric.group.Group</span></code> objects (which wrap
some number of <code class="xref py py-obj docutils literal notranslate"><span class="pre">fabric.connection.Connection</span></code> instances with “do a
thing to all members” methods.) Users can create &amp; organize these any
way they want.</p>
<p>See the line items for <code class="docutils literal notranslate"><span class="pre">--roles</span></code> (<a class="reference internal" href="#upgrading-cli"><span class="std std-ref">CLI arguments, options and behavior</span></a>),
<code class="docutils literal notranslate"><span class="pre">env.roles</span></code> (<a class="reference internal" href="#upgrading-env"><span class="std std-ref">fabric.env reference</span></a>) and <code class="docutils literal notranslate"><span class="pre">&#64;roles</span></code>
(<a class="reference internal" href="#upgrading-tasks"><span class="std std-ref">Task functions &amp; decorators</span></a>) for the status of those specifics.</p>
</td>
</tr>
</tbody>
</table>
</section>
<section id="task-functions-decorators">
<span id="upgrading-tasks"></span><h3><a class="toc-backref" href="#id7" role="doc-backlink">Task functions &amp; decorators</a><a class="headerlink" href="#task-functions-decorators" title="Permalink to this heading">¶</a></h3>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>Nearly all task-related functionality is implemented in Invoke; for more
details see its <span class="xref std std-ref">execution</span> and <span class="xref std std-ref">namespaces</span> documentation.</p>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 40%" />
<col style="width: 10%" />
<col style="width: 50%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>By default, tasks are loaded from a <code class="docutils literal notranslate"><span class="pre">fabfile.py</span></code> which is sought up
towards filesystem root from the user’s current working directory</p></td>
<td><p>Ported</p></td>
<td><p>This behavior is basically identical today, with minor modifications
and enhancements (such as tighter control over the load process, and
API hooks for implementing custom loader logic - see
<span class="xref std std-ref">loading-collections</span>.)</p></td>
</tr>
<tr class="row-even"><td><p>“Classic” style implicit task functions lacking a <code class="docutils literal notranslate"><span class="pre">&#64;task</span></code> decorator</p></td>
<td><p>Removed</p></td>
<td><p>These were on the way out even in v1, and arbitrary task/namespace
creation is more explicitly documented now, via Invoke’s
<code class="xref py py-obj docutils literal notranslate"><span class="pre">Task</span></code> and <code class="xref py py-obj docutils literal notranslate"><span class="pre">Collection</span></code>.</p></td>
</tr>
<tr class="row-odd"><td><p>“New” style <code class="docutils literal notranslate"><span class="pre">&#64;task</span></code>-decorated, module-level task functions</p></td>
<td><p>Ported</p></td>
<td><p>Largely the same, though now with superpowers - <code class="xref py py-obj docutils literal notranslate"><span class="pre">&#64;task</span></code> can still be used without any parentheses, but
where v1 only had a single <code class="docutils literal notranslate"><span class="pre">task_class</span></code> argument, the new version
(largely based on Invoke’s) has a number of namespace and parser hints,
as well as execution related options (such as those formerly served by
<code class="docutils literal notranslate"><span class="pre">&#64;hosts</span></code> and friends).</p></td>
</tr>
<tr class="row-even"><td><p>Arbitrary task function arguments (i.e. <code class="docutils literal notranslate"><span class="pre">def</span> <span class="pre">mytask(any,</span> <span class="pre">thing,</span> <span class="pre">at,</span>
<span class="pre">all)</span></code>)</p></td>
<td><p>Ported</p></td>
<td><p>This gets its own line item because: tasks must now take a
<code class="xref py py-obj docutils literal notranslate"><span class="pre">Context</span></code> (vanilla Invoke) or
<code class="xref py py-obj docutils literal notranslate"><span class="pre">fabric.connection.Connection</span></code> (Fabric) object as their first
positional argument. The rest of the function signature is, as before,
totally up to the user &amp; will get automatically turned into CLI flags.</p>
<p>This sacrifices a small bit of the “quick DSL” of v1 in exchange for a
cleaner, easier to understand/debug, and more user-overrideable API
structure.</p>
<p>As a side effect, it lessens the distinction between “module of
functions” and “class of methods”; users can more easily start with the
former and migrate to the latter when their needs grow/change.</p>
</td>
</tr>
<tr class="row-odd"><td><p>Implicit task tree generation via import-crawling</p></td>
<td><p>Ported/Removed</p></td>
<td><p>Namespace construction is now more explicit; for example, imported
modules in your <code class="docutils literal notranslate"><span class="pre">fabfile.py</span></code> are no longer auto-scanned and
auto-added to the task tree.</p>
<p>However, the root <code class="docutils literal notranslate"><span class="pre">fabfile.py</span></code> <em>is</em> automatically loaded (using
<code class="xref py py-obj docutils literal notranslate"><span class="pre">Collection.from_module</span></code>),
preserving the simple/common case. See <span class="xref std std-ref">task-namespaces</span> for
details.</p>
<p>We may reinstate (in an opt-in fashion) imported module scanning later,
since the use of explicit namespace objects still allows users control
over the tree that results.</p>
</td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">&#64;hosts</span></code> for determining the default host or list of hosts a given
task uses</p></td>
<td><p>Ported</p></td>
<td><p>Reinstated as the <code class="docutils literal notranslate"><span class="pre">hosts</span></code> parameter of <code class="xref py py-obj docutils literal notranslate"><span class="pre">&#64;task</span></code>.
Further, it can now handle dicts of <code class="xref py py-obj docutils literal notranslate"><span class="pre">fabric.connection.Connection</span></code>
kwargs in addition to simple host strings.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">&#64;roles</span></code> for determining the default list of group-of-host targets a
given task uses</p></td>
<td><p>Pending</p></td>
<td><p>See <a class="reference internal" href="#upgrading-api"><span class="std std-ref">API organization</span></a> for details on the overall ‘roles’ concept.
When it returns, this will probably follow <code class="docutils literal notranslate"><span class="pre">&#64;hosts</span></code> and become some
<code class="docutils literal notranslate"><span class="pre">&#64;task</span></code> argument.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">&#64;serial</span></code>/<code class="docutils literal notranslate"><span class="pre">&#64;parallel</span></code>/<code class="docutils literal notranslate"><span class="pre">&#64;runs_once</span></code></p></td>
<td><p>Ported/<a class="reference external" href="https://github.com/pyinvoke/invoke/issues/63">Pending</a></p></td>
<td><p>Parallel execution is currently offered at the API level via
<code class="xref py py-obj docutils literal notranslate"><span class="pre">fabric.group.Group</span></code> subclasses such as <code class="xref py py-obj docutils literal notranslate"><span class="pre">fabric.group.ThreadingGroup</span></code>;
however, designating entire sessions and/or tasks to run in parallel
(or to exempt from parallelism) has not been solved yet.</p>
<p>The problem needs solving at a higher level than just SSH targets, so
this links to an Invoke-level ticket.</p>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">execute</span></code> for calling named tasks from other tasks while honoring
decorators and other execution mechanics (as opposed to calling them
simply as functions)</p></td>
<td><p><a class="reference external" href="https://github.com/pyinvoke/invoke/issues/170">Pending</a></p></td>
<td><p>This is one of the top “missing features” from the rewrite; link is to
Invoke’s tracker.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Task</span></code> class for programmatic creation of tasks (as opposed to using
some function object and the <code class="docutils literal notranslate"><span class="pre">&#64;task</span></code> decorator)</p></td>
<td><p>Ported</p></td>
<td><p>While not sharing many implementation details with v1, modern Fabric
(via Invoke) has a publicly exposed <code class="xref py py-obj docutils literal notranslate"><span class="pre">Task</span></code> class, which
alongside <code class="xref py py-obj docutils literal notranslate"><span class="pre">Collection</span></code> allow full programmatic
creation of task trees, no decorator needed.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="cli-arguments-options-and-behavior">
<span id="upgrading-cli"></span><h3><a class="toc-backref" href="#id8" role="doc-backlink">CLI arguments, options and behavior</a><a class="headerlink" href="#cli-arguments-options-and-behavior" title="Permalink to this heading">¶</a></h3>
<table class="docutils align-default">
<colgroup>
<col style="width: 40%" />
<col style="width: 10%" />
<col style="width: 50%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>Exposure of task arguments as custom colon/comma delimited CLI
arguments, e.g. <code class="docutils literal notranslate"><span class="pre">fab</span> <span class="pre">mytask:posarg,kwarg=val</span></code></p></td>
<td><p>Removed</p></td>
<td><p>CLI arguments are now proper GNU/POSIX-style long and short flags,
including globbing shortflags together, space or equals signs to attach
values, optional values, and much more. See <span class="xref std std-ref">invoking-tasks</span>.</p></td>
</tr>
<tr class="row-even"><td><p>Task definition names are mirrored directly on the command-line, e.g
for task <code class="docutils literal notranslate"><span class="pre">def</span> <span class="pre">journald_logs()</span></code>, command line argument is <code class="docutils literal notranslate"><span class="pre">fab</span>
<span class="pre">journald_logs</span></code></p></td>
<td><p>Removed</p></td>
<td><p>Tasks names now get converted from underscores to hyphens. Eg. task
<code class="docutils literal notranslate"><span class="pre">def</span> <span class="pre">journald_logs()</span></code> now evaluates to <code class="docutils literal notranslate"><span class="pre">fab</span> <span class="pre">journald-logs</span></code> on the
commandline.</p></td>
</tr>
<tr class="row-odd"><td><p>Ability to invoke multiple tasks in a single command line, e.g. <code class="docutils literal notranslate"><span class="pre">fab</span>
<span class="pre">task1</span> <span class="pre">task2</span></code></p></td>
<td><p>Ported</p></td>
<td><p>Works great!</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">-m</span> <span class="pre">fabric</span></code> as stand-in for <code class="docutils literal notranslate"><span class="pre">fab</span></code></p></td>
<td><p>Ported</p></td>
<td><p>Ported in 2.2.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">-a</span></code>/<code class="docutils literal notranslate"><span class="pre">--no_agent</span></code> for disabling automatic SSH agent key selection</p></td>
<td><p>Removed</p></td>
<td><p>To disable use of an agent permanently, set config value
<code class="docutils literal notranslate"><span class="pre">connect_kwargs.allow_agent</span></code> to <code class="docutils literal notranslate"><span class="pre">False</span></code>; to disable temporarily,
unset the <code class="docutils literal notranslate"><span class="pre">SSH_AUTH_SOCK</span></code> env var.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">-A</span></code>/<code class="docutils literal notranslate"><span class="pre">--forward-agent</span></code> for enabling agent forwarding to the remote
end</p></td>
<td><p>Removed</p></td>
<td><p>The config and kwarg versions of this are ported, but there is
currently no CLI flag. Usual “you can set the config value at runtime
with a shell env variable” clause is in effect, so this <em>may</em> not get
ported, depending.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--abort-on-prompts</span></code> to turn interactive prompts into exceptions
(helps avoid ‘hanging’ sessions)</p></td>
<td><p>Removed</p></td>
<td><p>See the notes about interactive prompts going away in
<a class="reference internal" href="#upgrading-general"><span class="std std-ref">General / conceptual</span></a>. Without mid-session prompts, there’s no need
for this option.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">-c</span></code>/<code class="docutils literal notranslate"><span class="pre">--config</span></code> for specifying an alternate config file path</p></td>
<td><p>Ported</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">--config</span></code> lives on, but the short flag is now <code class="docutils literal notranslate"><span class="pre">-f</span></code> (<code class="docutils literal notranslate"><span class="pre">-c</span></code> now
determines which collection module name is sought by the task loader.)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--colorize-errors</span></code> (and <code class="docutils literal notranslate"><span class="pre">env.colorize_errors</span></code>) to enable ANSI
coloring of error output</p></td>
<td><p><a class="reference external" href="https://github.com/fabric/fabric/issues/101">Pending</a></p></td>
<td><p>Very little color work has been done yet and this is one of the
potentially missing pieces. We’re unsure how often this was used in v1
so it’s possible it won’t show up again, but generally, we like using
color as an additional output vector, so…</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">-d</span></code>/<code class="docutils literal notranslate"><span class="pre">--display</span></code> for showing info on a given command</p></td>
<td><p>Ported</p></td>
<td><p>This is now the more standard <code class="docutils literal notranslate"><span class="pre">-h</span></code>/<code class="docutils literal notranslate"><span class="pre">--help</span></code>, and can be given in
either “direction”: <code class="docutils literal notranslate"><span class="pre">fab</span> <span class="pre">-h</span> <span class="pre">mytask</span></code> or <code class="docutils literal notranslate"><span class="pre">fab</span> <span class="pre">mytask</span> <span class="pre">-h</span></code>.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">-D</span></code>/<code class="docutils literal notranslate"><span class="pre">--disable-known-hosts</span></code> to turn off Paramiko’s automatic
loading of user-level <code class="docutils literal notranslate"><span class="pre">known_hosts</span></code> files</p></td>
<td><p><a class="reference external" href="https://github.com/fabric/fabric/issues/1804">Pending</a></p></td>
<td><p>Not ported yet, probably will be.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">-e</span></code>/<code class="docutils literal notranslate"><span class="pre">--eagerly-disconnect</span></code> (and <code class="docutils literal notranslate"><span class="pre">env.eagerly_disconnect</span></code>) which
tells the execution system to disconnect from hosts as soon as a task
is done running</p></td>
<td><p>Ported/<a class="reference external" href="https://github.com/fabric/fabric/issues/1805">Pending</a></p></td>
<td><p>There’s no explicit connection cache anymore, so eager disconnection
should be less necessary. However, investigation and potential feature
toggles are still pending.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">-f</span></code>/<code class="docutils literal notranslate"><span class="pre">--fabfile</span></code> to select alternate fabfile location</p></td>
<td><p>Ported</p></td>
<td><p>This is now split up into <code class="docutils literal notranslate"><span class="pre">-c</span></code>/<code class="docutils literal notranslate"><span class="pre">--collection</span></code> and
<code class="docutils literal notranslate"><span class="pre">-r</span></code>/<code class="docutils literal notranslate"><span class="pre">--search-root</span></code>; see <span class="xref std std-ref">loading-collections</span>.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">-g</span></code>/<code class="docutils literal notranslate"><span class="pre">--gateway</span></code> (and <code class="docutils literal notranslate"><span class="pre">env.gateway</span></code>) for selecting a global SSH
gateway host string</p></td>
<td><p><a class="reference external" href="https://github.com/fabric/fabric/issues/1806">Pending</a></p></td>
<td><p>One can set the global <code class="docutils literal notranslate"><span class="pre">gateway</span></code> config option via an
environment variable, which at a glance would remove the need for a
dedicated CLI option. However, this approach only allows setting
string values, which in turn only get used for <code class="docutils literal notranslate"><span class="pre">ProxyCommand</span></code>
style gatewaying, so it <em>doesn’t</em> replace v1’s <code class="docutils literal notranslate"><span class="pre">--gateway</span></code>
(which took a host string and turned it into a <code class="docutils literal notranslate"><span class="pre">ProxyJump</span></code> style
gateway).</p>
<p>Thus, if enough users notice the lack, we’ll consider a feature-add
that largely mimics the v1 behavior: string becomes first argument to
<code class="xref py py-obj docutils literal notranslate"><span class="pre">fabric.connection.Connection</span></code> and that resulting object is then set as
<code class="docutils literal notranslate"><span class="pre">gateway</span></code>.</p>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--gss-auth</span></code>/<code class="docutils literal notranslate"><span class="pre">--gss-deleg</span></code>/<code class="docutils literal notranslate"><span class="pre">--gss-kex</span></code></p></td>
<td><p>Removed</p></td>
<td><p>These didn’t seem used enough to be worth porting over, especially
since they fall under the usual umbrella of “Paramiko-level connect
passthrough” covered by the <code class="docutils literal notranslate"><span class="pre">connect_kwargs</span></code> config option. (Which,
if necessary, can be set at runtime via shell environment variables,
like any other config value.)</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--hide</span></code>/<code class="docutils literal notranslate"><span class="pre">--show</span></code> for tweaking output display globally</p></td>
<td><p>Removed</p></td>
<td><p>This is configurable via the config system and env vars.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">-H</span></code>/<code class="docutils literal notranslate"><span class="pre">--hosts</span></code></p></td>
<td><p>Ported</p></td>
<td><p>Works basically the same as before - if given, is shorthand for
executing any given tasks once per host.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">-i</span></code> for SSH key filename selection</p></td>
<td><p>Ported</p></td>
<td><p>Works same as v1, including ability to give multiple times to build a
list of keys to try.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">-I</span></code>/<code class="docutils literal notranslate"><span class="pre">--initial-password-prompt</span></code> for requesting an initial
pre-execution password prompt</p></td>
<td><p>Ported</p></td>
<td><p>It’s now <code class="xref std std-option docutils literal notranslate"><span class="pre">--prompt-for-login-password</span></code>,
<span class="xref std std-ref">–prompt-for-sudo-password</span> or
<code class="xref std std-option docutils literal notranslate"><span class="pre">--prompt-for-passphrase</span></code>, depending on whether you were using
the former to fill in passwords or key passphrases (or both.)</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--initial-sudo-password-prompt</span></code> for requesting an initial
pre-execution sudo password prompt</p></td>
<td><p>Ported</p></td>
<td><p>This is now <code class="xref std std-option docutils literal notranslate"><span class="pre">--prompt-for-sudo-password</span></code>. Still a bit of a
mouthful but still 4 characters shorter!</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">-k</span></code>/<code class="docutils literal notranslate"><span class="pre">--no-keys</span></code> which prevents Paramiko’s automatic loading of key
files such as <code class="docutils literal notranslate"><span class="pre">~/.ssh/id_rsa</span></code></p></td>
<td><p>Removed</p></td>
<td><p>Use environment variables to set the <code class="docutils literal notranslate"><span class="pre">connect_kwargs.look_for_keys</span></code>
config value to <code class="docutils literal notranslate"><span class="pre">False</span></code>.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--keepalive</span></code> for setting network keepalive</p></td>
<td><p><a class="reference external" href="https://github.com/fabric/fabric/issues/1807">Pending</a></p></td>
<td><p>Not ported yet.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">-l</span></code>/<code class="docutils literal notranslate"><span class="pre">--list</span></code> for listing tasks, plus <code class="docutils literal notranslate"><span class="pre">-F</span></code>/<code class="docutils literal notranslate"><span class="pre">--list-format</span></code> for
tweaking list display format</p></td>
<td><p>Ported</p></td>
<td><p>Now with bonus JSON list-format! Which incidentally replaces <code class="docutils literal notranslate"><span class="pre">-F</span>
<span class="pre">short</span></code>/<code class="docutils literal notranslate"><span class="pre">--shortlist</span></code>.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--linewise</span></code> for buffering output line by line instead of roughly
byte by byte</p></td>
<td><p>Removed</p></td>
<td><p>This doesn’t really fit with the way modern command execution code
views the world, so it’s gone.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">-n</span></code>/<code class="docutils literal notranslate"><span class="pre">--connection-attempts</span></code> controlling multiple connect retries</p></td>
<td><p><a class="reference external" href="https://github.com/fabric/fabric/issues/1808">Pending</a></p></td>
<td><p>Not ported yet.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--no-pty</span></code> to disable automatic PTY allocation in <code class="docutils literal notranslate"><span class="pre">run</span></code>, etc</p></td>
<td><p>Ported</p></td>
<td><p>Is now <code class="docutils literal notranslate"><span class="pre">-p</span></code>/<code class="docutils literal notranslate"><span class="pre">--pty</span></code> as the default behavior was switched around.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--password</span></code>/<code class="docutils literal notranslate"><span class="pre">--sudo-password</span></code> for specifying login/sudo password
values</p></td>
<td><p>Removed</p></td>
<td><p>This is typically not very secure to begin with, and there are now many
other avenues for setting the related configuration values, so
they’re gone at least for now.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">-P</span></code>/<code class="docutils literal notranslate"><span class="pre">--parallel</span></code> for activating global parallelism</p></td>
<td><p><a class="reference external" href="https://github.com/pyinvoke/invoke/issues/63">Pending</a></p></td>
<td><p>See the notes around <code class="docutils literal notranslate"><span class="pre">&#64;parallel</span></code> in <a class="reference internal" href="#upgrading-tasks"><span class="std std-ref">Task functions &amp; decorators</span></a>.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--port</span></code> to set default SSH port</p></td>
<td><p>Removed</p></td>
<td><p>Our gut says this is best left up to the configuration system’s env var
layer, or use of the <code class="docutils literal notranslate"><span class="pre">port</span></code> kwarg on <code class="xref py py-obj docutils literal notranslate"><span class="pre">fabric.connection.Connection</span></code>;
however it may find its way back.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">r</span></code>/<code class="docutils literal notranslate"><span class="pre">--reject-unknown-hosts</span></code> to modify Paramiko known host behavior</p></td>
<td><p><a class="reference external" href="https://github.com/fabric/fabric/issues/1804">Pending</a></p></td>
<td><p>Not ported yet.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">-R</span></code>/<code class="docutils literal notranslate"><span class="pre">--roles</span></code> for global list-of-hosts target selection</p></td>
<td><p><a class="reference external" href="https://github.com/fabric/fabric/issues/1594">Pending</a></p></td>
<td><p>As noted under <a class="reference internal" href="#upgrading-api"><span class="std std-ref">API organization</span></a>, role lists are only partially
applicable to the new API and we’re still feeling out whether/how they
would work at a global or CLI level.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--set</span> <span class="pre">key=value</span></code> for setting <code class="docutils literal notranslate"><span class="pre">fabric.state.env</span></code> vars at runtime</p></td>
<td><p>Removed</p></td>
<td><p>This is largely obviated by the new support for shell environment
variables (just do <code class="docutils literal notranslate"><span class="pre">INVOKE_KEY=value</span> <span class="pre">fab</span> <span class="pre">mytask</span></code> or similar), though
it’s remotely possible a CLI flag method of setting config values will
reappear later.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">-s</span></code>/<code class="docutils literal notranslate"><span class="pre">--shell</span></code> to override default shell path</p></td>
<td><p>Removed</p></td>
<td><p>Use the configuration system for this.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--shortlist</span></code> for short/computer-friendly list output</p></td>
<td><p>Ported</p></td>
<td><p>See <code class="docutils literal notranslate"><span class="pre">--list</span></code>/<code class="docutils literal notranslate"><span class="pre">--list-format</span></code> - there’s now a JSON format instead.
No point reinventing the wheel.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--skip-bad-hosts</span></code> (and <code class="docutils literal notranslate"><span class="pre">env.skip_bad_hosts</span></code>) to bypass problematic
hosts</p></td>
<td><p><a class="reference external" href="https://github.com/fabric/fabric/issues/1809">Pending</a></p></td>
<td><p>Not ported yet.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--skip-unknown-tasks</span></code> and <code class="docutils literal notranslate"><span class="pre">env.skip_unknown_tasks</span></code> for silently
skipping past bogus task names on CLI invocation</p></td>
<td><p>Removed</p></td>
<td><p>This felt mostly like bloat to us and could require nontrivial parser
changes to reimplement, so it’s out for now.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--ssh-config-path</span></code> and <code class="docutils literal notranslate"><span class="pre">env.ssh_config_path</span></code> for selecting an SSH
config file</p></td>
<td><p>Ported</p></td>
<td><p>This is now <code class="docutils literal notranslate"><span class="pre">-S</span></code>/<code class="docutils literal notranslate"><span class="pre">--ssh-config</span></code>.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--system-known-hosts</span></code> to trigger loading systemwide <code class="docutils literal notranslate"><span class="pre">known_hosts</span></code>
files</p></td>
<td><p><a class="reference external" href="https://github.com/fabric/fabric/issues/1804">Pending</a>/Removed</p></td>
<td><p>This isn’t super likely to come back as its own CLI flag but it may
well return as a configuration value.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">-t</span></code>/<code class="docutils literal notranslate"><span class="pre">--timeout</span></code> controlling connection timeout</p></td>
<td><p>Ported</p></td>
<td><p>It’s now <code class="docutils literal notranslate"><span class="pre">-t</span></code>/<code class="docutils literal notranslate"><span class="pre">--connect-timeout</span></code> as <code class="docutils literal notranslate"><span class="pre">--timeout</span></code> was technically
ambiguous re: connect vs command timeout.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">-T</span></code>/<code class="docutils literal notranslate"><span class="pre">--command-timeout</span></code></p></td>
<td><p>Ported</p></td>
<td><p>Implemented in Invoke and preserved in <code class="docutils literal notranslate"><span class="pre">fab</span></code> under the same name.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">-u</span></code>/<code class="docutils literal notranslate"><span class="pre">--user</span></code> to set global default username</p></td>
<td><p>Removed</p></td>
<td><p>Most of the time, configuration (env vars for true runtime, or eg
user/project level config files as appropriate) should be used for
this, but it may return.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">-w</span></code>/<code class="docutils literal notranslate"><span class="pre">--warn-only</span></code> to toggle warn-vs-abort behavior</p></td>
<td><p>Ported</p></td>
<td><p>Ported as-is, no changes.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">-x</span></code>/<code class="docutils literal notranslate"><span class="pre">--exclude-hosts</span></code> (and <code class="docutils literal notranslate"><span class="pre">env.exclude_hosts</span></code>) for excluding
otherwise selected targets</p></td>
<td><p><a class="reference external" href="https://github.com/fabric/fabric/issues/1594">Pending</a></p></td>
<td><p>Not ported yet, is pending an in depth rework of global (vs
hand-instantiated) connection/group selection.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">-z</span></code>/<code class="docutils literal notranslate"><span class="pre">--pool-size</span></code> for setting parallel-mode job queue pool size</p></td>
<td><p>Removed</p></td>
<td><p>There’s no job queue anymore, or at least at present. Whatever replaces
it (besides the already-implemented threading model) is likely to look
pretty different.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="shell-command-execution-local-run-sudo">
<span id="upgrading-commands"></span><h3><a class="toc-backref" href="#id9" role="doc-backlink">Shell command execution (<code class="docutils literal notranslate"><span class="pre">local</span></code>/<code class="docutils literal notranslate"><span class="pre">run</span></code>/<code class="docutils literal notranslate"><span class="pre">sudo</span></code>)</a><a class="headerlink" href="#shell-command-execution-local-run-sudo" title="Permalink to this heading">¶</a></h3>
<section id="general">
<h4><a class="toc-backref" href="#id10" role="doc-backlink">General</a><a class="headerlink" href="#general" title="Permalink to this heading">¶</a></h4>
<p>Behaviors shared across either <code class="docutils literal notranslate"><span class="pre">run</span></code>/<code class="docutils literal notranslate"><span class="pre">sudo</span></code>, or all of
<code class="docutils literal notranslate"><span class="pre">run</span></code>/<code class="docutils literal notranslate"><span class="pre">sudo</span></code>/<code class="docutils literal notranslate"><span class="pre">local</span></code>. Subsequent sections go into per-function
differences.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 40%" />
<col style="width: 10%" />
<col style="width: 50%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">local</span></code> and <code class="docutils literal notranslate"><span class="pre">run</span></code>/<code class="docutils literal notranslate"><span class="pre">sudo</span></code> have wildly differing APIs and
implementations</p></td>
<td><p>Removed</p></td>
<td><p>All command execution is now unified; all three functions (now
methods on <code class="xref py py-obj docutils literal notranslate"><span class="pre">fabric.connection.Connection</span></code>, though <code class="docutils literal notranslate"><span class="pre">local</span></code> is also
available as <code class="xref py py-obj docutils literal notranslate"><span class="pre">invoke.run</span></code> for standalone use) have the same underlying
protocol and logic (the <code class="xref py py-obj docutils literal notranslate"><span class="pre">Runner</span></code> class hierarchy), with
only low-level details like process creation and pipe consumption
differing.</p>
<p>For example, in v1 <code class="docutils literal notranslate"><span class="pre">local</span></code> required you to choose between displaying
and capturing subprocess output; modern <code class="docutils literal notranslate"><span class="pre">local</span></code> is like <code class="docutils literal notranslate"><span class="pre">run</span></code> and
does both at the same time.</p>
</td>
</tr>
<tr class="row-even"><td><p>Prompt auto-response, via <code class="docutils literal notranslate"><span class="pre">env.prompts</span></code> and/or <code class="docutils literal notranslate"><span class="pre">sudo</span></code>’s internals</p></td>
<td><p>Ported</p></td>
<td><p>The <code class="docutils literal notranslate"><span class="pre">env.prompts</span></code> functionality has been significantly fleshed out,
into a framework of <span class="xref std std-ref">Watchers</span> which operate on
any (local or remote!) running command’s input and output streams.</p>
<p>In addition, <code class="docutils literal notranslate"><span class="pre">sudo</span></code> has been rewritten to use that framework; while
still useful enough to offer an implementation in core, it no longer
does anything users cannot do themselves using public APIs.</p>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">fabric.context_managers.cd</span></code>/<code class="docutils literal notranslate"><span class="pre">lcd</span></code> (and <code class="docutils literal notranslate"><span class="pre">prefix</span></code>) allow scoped
mutation of executed comments</p></td>
<td><p>Ported/<a class="reference external" href="https://github.com/fabric/fabric/issues/1752">Pending</a></p></td>
<td><p>These are now methods on <code class="xref py py-obj docutils literal notranslate"><span class="pre">Context</span></code> (<code class="xref py py-obj docutils literal notranslate"><span class="pre">Context.cd</span></code>, <code class="xref py py-obj docutils literal notranslate"><span class="pre">Context.prefix</span></code>) but need work in its subclass
<code class="xref py py-obj docutils literal notranslate"><span class="pre">fabric.connection.Connection</span></code> (quite possibly including recreating
<code class="docutils literal notranslate"><span class="pre">lcd</span></code>) so that local vs remote state are separated.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">fabric.context_managers.shell_env</span></code> and its specific expression
<code class="docutils literal notranslate"><span class="pre">path</span></code> (plus <code class="docutils literal notranslate"><span class="pre">env.shell_env</span></code>, <code class="docutils literal notranslate"><span class="pre">env.path</span></code> and
<code class="docutils literal notranslate"><span class="pre">env.path_behavior</span></code>), for modifying remote environment variables
(locally, one would just modify <a class="reference external" href="https://docs.python.org/3/library/os.html#os.environ" title="(在 Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">os.environ</span></code></a>.)</p></td>
<td><p>Ported</p></td>
<td><p>The context managers were the only way to set environment variables at
any scope; in modern Fabric, subprocess shell environment is
controllable per-call (directly in <code class="xref py py-obj docutils literal notranslate"><span class="pre">fabric.connection.Connection.run</span></code>
and siblings via an <code class="docutils literal notranslate"><span class="pre">env</span></code> kwarg) <em>and</em> across multiple calls (by
manipulating the configuration system, statically or at runtime.)</p></td>
</tr>
<tr class="row-odd"><td><p>Controlling subprocess output &amp; other activity display text by
manipulating <code class="docutils literal notranslate"><span class="pre">fabric.state.output</span></code> (directly or via
<code class="docutils literal notranslate"><span class="pre">fabric.context_managers.hide</span></code>, <code class="docutils literal notranslate"><span class="pre">show</span></code> or <code class="docutils literal notranslate"><span class="pre">quiet</span></code> as well as the
<code class="docutils literal notranslate"><span class="pre">quiet</span></code> kwarg to <code class="docutils literal notranslate"><span class="pre">run</span></code>/<code class="docutils literal notranslate"><span class="pre">sudo</span></code>; plus
<code class="docutils literal notranslate"><span class="pre">utils.puts</span></code>/<code class="docutils literal notranslate"><span class="pre">fastprint</span></code>)</p></td>
<td><p>Ported/<a class="reference external" href="https://github.com/pyinvoke/invoke/issues/15">Pending</a></p></td>
<td><p>The core concept of “output levels” is gone, likely to be replaced in
the near term by a logging module (stdlib or other) which output levels
poorly reimplemented.</p>
<p>Command execution methods like <code class="xref py py-obj docutils literal notranslate"><span class="pre">run</span></code> retain a
<code class="docutils literal notranslate"><span class="pre">hide</span></code> kwarg controlling which subprocess streams are copied to your
terminal, and an <code class="docutils literal notranslate"><span class="pre">echo</span></code> kwarg controlling whether commands are
printed before execution. All of these also honor the configuration
system.</p>
</td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">timeout</span></code> kwarg and the <code class="docutils literal notranslate"><span class="pre">CommandTimeout</span></code> exception raised when said
command-runtime timeout was violated</p></td>
<td><p>Ported</p></td>
<td><p>Primarily lives at the Invoke layer now, but applies to all command
execution, local or remote; see the <code class="docutils literal notranslate"><span class="pre">timeout</span></code> argument to
<code class="xref py py-obj docutils literal notranslate"><span class="pre">run</span></code> and its related configuration value and
CLI flag.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">pty</span></code> kwarg and <code class="docutils literal notranslate"><span class="pre">env.always_use_pty</span></code>, controlling whether commands
run in a pseudo-terminal or are invoked directly</p></td>
<td><p>Ported</p></td>
<td><p>This has been thoroughly ported (and its behavior often improved)
including preservation of the <code class="docutils literal notranslate"><span class="pre">pty</span></code> kwarg and updating the config
value to be simply <code class="docutils literal notranslate"><span class="pre">run.pty</span></code>. However, a major change is that pty
allocation is now <code class="docutils literal notranslate"><span class="pre">False</span></code> by default instead of <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p>
<p>Fabric 0.x and 1.x already changed this value around; during Fabric 1’s
long lifetime it became clear that neither default works for all or
even most users, so we opted to return the default to <code class="docutils literal notranslate"><span class="pre">False</span></code> as it’s
cleaner and less wasteful.</p>
</td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">combine_stderr</span></code> (kwarg and <code class="docutils literal notranslate"><span class="pre">env.combine_stderr</span></code>) controlling
whether Paramiko weaves remote stdout and stderr into the stdout stream</p></td>
<td><p>Removed</p></td>
<td><p>This wasn’t terrifically useful, and often caused conceptual problems
in tandem with <code class="docutils literal notranslate"><span class="pre">pty</span></code> (as pseudo-terminals by their nature always
combine the two streams.)</p>
<p>We recommend users who really need both streams to be merged, either
use shell redirection in their command, or set <code class="docutils literal notranslate"><span class="pre">pty=True</span></code>.</p>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">warn_only</span></code> kwarg for preventing automatic abort on non-zero return
codes</p></td>
<td><p>Ported</p></td>
<td><p>This is now just <code class="docutils literal notranslate"><span class="pre">warn</span></code>, both kwarg and config value. It continues to
default to <code class="docutils literal notranslate"><span class="pre">False</span></code>.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">stdout</span></code> and <code class="docutils literal notranslate"><span class="pre">stderr</span></code> kwargs for reassigning default stdout/err
mirroring targets, which otherwise default to the appropriate <a class="reference external" href="https://docs.python.org/3/library/sys.html#module-sys" title="(在 Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">sys</span></code></a>
members</p></td>
<td><p>Ported</p></td>
<td><p>These are now <code class="docutils literal notranslate"><span class="pre">out_stream</span></code> and <code class="docutils literal notranslate"><span class="pre">err_stream</span></code> but otherwise remain
similar in nature. They are also accompanied by the new, rather obvious
in hindsight <code class="docutils literal notranslate"><span class="pre">in_stream</span></code>.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">capture_buffer_size</span></code> arg &amp; use of a ring buffer for storing captured
stdout/stderr to limit total size</p></td>
<td><p><a class="reference external" href="https://github.com/pyinvoke/invoke/issues/344">Pending</a></p></td>
<td><p>Existing <code class="xref py py-obj docutils literal notranslate"><span class="pre">Runner</span></code> implementation uses regular lists for
capture buffers, but we fully expect to upgrade this to a ring buffer
or similar at some point.</p></td>
</tr>
<tr class="row-even"><td><p>Return values are string-like objects with extra attributes like
<code class="docutils literal notranslate"><span class="pre">succeeded</span></code> and <code class="docutils literal notranslate"><span class="pre">return_code</span></code> sprinkled on top</p></td>
<td><p>Ported</p></td>
<td><p>Return values are no longer string-a-likes with a semi-private API, but
are full fledged regular objects of type <code class="xref py py-obj docutils literal notranslate"><span class="pre">Result</span></code>. They
expose all of the same info as the old “attribute strings”, and only
really differ in that they don’t pretend to be strings themselves.</p>
<p>They do, however, still behave as booleans - just ones reflecting the
exit code’s relation to zero instead of whether there was any stdout.</p>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">open_shell</span></code> for obtaining interactive-friendly remote shell sessions
(something that <code class="docutils literal notranslate"><span class="pre">run</span></code> historically was bad at )</p></td>
<td><p>Ported</p></td>
<td><p>Not only is the new version of <code class="docutils literal notranslate"><span class="pre">run</span></code> vastly improved and able to deal
with interactive sessions at least as well as the old <code class="docutils literal notranslate"><span class="pre">open_shell</span></code>
(provided you supply <code class="docutils literal notranslate"><span class="pre">pty=True</span></code>), but for corner cases there’s also a
direct port: <code class="xref py py-obj docutils literal notranslate"><span class="pre">shell</span></code>.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="run">
<h4><a class="toc-backref" href="#id11" role="doc-backlink"><code class="docutils literal notranslate"><span class="pre">run</span></code></a><a class="headerlink" href="#run" title="Permalink to this heading">¶</a></h4>
<table class="docutils align-default">
<colgroup>
<col style="width: 40%" />
<col style="width: 10%" />
<col style="width: 50%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">shell</span></code> / <code class="docutils literal notranslate"><span class="pre">env.use_shell</span></code> designating whether or not to wrap
commands within an explicit call to e.g. <code class="docutils literal notranslate"><span class="pre">/bin/sh</span> <span class="pre">-c</span> <span class="pre">&quot;real</span> <span class="pre">command&quot;</span></code>;
plus their attendant options like <code class="docutils literal notranslate"><span class="pre">shell_escape</span></code></p></td>
<td><p>Removed</p></td>
<td><p>Non-<code class="docutils literal notranslate"><span class="pre">sudo</span></code> remote execution never truly required an explicit shell
wrapper: the remote SSH daemon hands your command string off to the
connecting user’s login shell in almost all cases. Since wrapping is
otherwise extremely error-prone and requires frustrating escaping
rules, we dropped it for this use case.</p>
<p>See the matching line items for <code class="docutils literal notranslate"><span class="pre">local</span></code> and <code class="docutils literal notranslate"><span class="pre">sudo</span></code> as their
situations differ. (For now, because they all share the same
underpinnings, <code class="xref py py-obj docutils literal notranslate"><span class="pre">fabric.connection.Connection.run</span></code> does accept a
<code class="docutils literal notranslate"><span class="pre">shell</span></code> kwarg - it just doesn’t do anything with it.)</p>
</td>
</tr>
</tbody>
</table>
</section>
<section id="sudo">
<h4><a class="toc-backref" href="#id12" role="doc-backlink"><code class="docutils literal notranslate"><span class="pre">sudo</span></code></a><a class="headerlink" href="#sudo" title="Permalink to this heading">¶</a></h4>
<p>Unless otherwise noted, all common <code class="docutils literal notranslate"><span class="pre">run``+``sudo</span></code> args/functionality (e.g.
<code class="docutils literal notranslate"><span class="pre">pty</span></code>, <code class="docutils literal notranslate"><span class="pre">warn_only</span></code> etc) are covered above in the section on <code class="docutils literal notranslate"><span class="pre">run</span></code>; the
below are <code class="docutils literal notranslate"><span class="pre">sudo</span></code> specific.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 40%" />
<col style="width: 10%" />
<col style="width: 50%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">shell</span></code> / <code class="docutils literal notranslate"><span class="pre">env.use_shell</span></code> designating whether or not to wrap
commands within an explicit call to e.g. <code class="docutils literal notranslate"><span class="pre">/bin/sh</span> <span class="pre">-c</span> <span class="pre">&quot;real</span> <span class="pre">command&quot;</span></code></p></td>
<td><p><a class="reference external" href="https://github.com/pyinvoke/invoke/issues/459">Pending</a>/Removed</p></td>
<td><p>See the note above under <code class="docutils literal notranslate"><span class="pre">run</span></code> for details on shell wrapping
as a general strategy; unfortunately for <code class="docutils literal notranslate"><span class="pre">sudo</span></code>, some sort of manual
wrapping is still necessary for nontrivial commands (i.e. anything
using actual shell syntax as opposed to a single program’s argv) due to
how the command string is handed off to the <code class="docutils literal notranslate"><span class="pre">sudo</span></code> program.</p>
<p>We hope to upgrade <code class="docutils literal notranslate"><span class="pre">sudo</span></code> soon so it can perform a common-best-case,
no-escaping-required shell wrapping on your behalf; see the ‘Pending’
link.</p>
</td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">user</span></code> argument (and <code class="docutils literal notranslate"><span class="pre">env.sudo_user</span></code>) allowing invocation via
<code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">-u</span> <span class="pre">&lt;user&gt;</span></code> (instead of defaulting to root)</p></td>
<td><p>Ported</p></td>
<td><p>This is still here, and still called <code class="docutils literal notranslate"><span class="pre">user</span></code>.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">group</span></code> argument controlling the effective group of the sudo’d
command</p></td>
<td><p><a class="reference external" href="https://github.com/pyinvoke/invoke/issues/540">Pending</a></p></td>
<td><p>This has not been ported yet.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="local">
<h4><a class="toc-backref" href="#id13" role="doc-backlink"><code class="docutils literal notranslate"><span class="pre">local</span></code></a><a class="headerlink" href="#local" title="Permalink to this heading">¶</a></h4>
<p>See the ‘general’ notes at top of this section for most details about the new
<code class="docutils literal notranslate"><span class="pre">local</span></code>. A few specific extras are below.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 40%" />
<col style="width: 10%" />
<col style="width: 50%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">shell</span></code> kwarg designating which shell to ask <a class="reference external" href="https://docs.python.org/3/library/subprocess.html#subprocess.Popen" title="(在 Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">subprocess.Popen</span></code></a> to
use</p></td>
<td><p>Ported</p></td>
<td><p>Basically the same as in v1, though there are now situations where
<a class="reference external" href="https://docs.python.org/3/library/os.html#os.execve" title="(在 Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">os.execve</span></code></a> (or similar) is used instead of <a class="reference external" href="https://docs.python.org/3/library/subprocess.html#subprocess.Popen" title="(在 Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">subprocess.Popen</span></code></a>.
Behavior is much the same: no shell wrapping (as in legacy <code class="docutils literal notranslate"><span class="pre">run</span></code>),
just informing the operating system what actual program to run.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="open-shell">
<h4><a class="toc-backref" href="#id14" role="doc-backlink"><code class="docutils literal notranslate"><span class="pre">open_shell</span></code></a><a class="headerlink" href="#open-shell" title="Permalink to this heading">¶</a></h4>
<p>As noted in the main list, this is now <code class="xref py py-obj docutils literal notranslate"><span class="pre">shell</span></code>,
and behaves similarly to <code class="docutils literal notranslate"><span class="pre">open_shell</span></code> (exit codes, if any, are ignored; a PTY
is assumed; etc). It has some improvements too, such as a return value (which
is slightly lacking compared to that from <code class="xref py py-obj docutils literal notranslate"><span class="pre">run</span></code>
but still a big improvement over <code class="docutils literal notranslate"><span class="pre">None</span></code>).</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 40%" />
<col style="width: 10%" />
<col style="width: 50%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">command</span></code> optional kwarg allowing ‘prefilling’ the input stream with
a specific command string plus newline</p></td>
<td><p>Removed</p></td>
<td><p>If you needed this, you should instead try the modern version of
<code class="xref py py-obj docutils literal notranslate"><span class="pre">run</span></code>, which is equally capable of
interaction as <code class="xref py py-obj docutils literal notranslate"><span class="pre">shell</span></code> but takes a
command to execute. There’s a small chance we’ll add this back later if
anybody misses it (there’s a few corner cases that could possibly want
it).</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="utilities">
<span id="upgrading-utility"></span><h3><a class="toc-backref" href="#id15" role="doc-backlink">Utilities</a><a class="headerlink" href="#utilities" title="Permalink to this heading">¶</a></h3>
<table class="docutils align-default">
<colgroup>
<col style="width: 40%" />
<col style="width: 10%" />
<col style="width: 50%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>Error handling via <code class="docutils literal notranslate"><span class="pre">abort</span></code> and <code class="docutils literal notranslate"><span class="pre">warn</span></code></p></td>
<td><p>Ported</p></td>
<td><p>The old functionality leaned too far in the “everything is a DSL”
direction &amp; didn’t offer enough value to offset how it gets in the way
of experienced Pythonistas.</p>
<p>These functions have been removed in favor of “just raise an exception”
(with one useful option being Invoke’s <code class="xref py py-obj docutils literal notranslate"><span class="pre">Exit</span></code>) as
exception handling feels more Pythonic than thin wrappers around
<code class="docutils literal notranslate"><span class="pre">sys.exit</span></code> or having to <code class="docutils literal notranslate"><span class="pre">except</span> <span class="pre">SystemExit:</span></code> and hope it was a
<a class="reference external" href="https://docs.python.org/3/library/exceptions.html#SystemExit" title="(在 Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">SystemExit</span></code></a> your own code raised!</p>
</td>
</tr>
<tr class="row-even"><td><p>ANSI color helpers in <code class="docutils literal notranslate"><span class="pre">fabric.colors</span></code> allowed users to easily print
ANSI colored text without a standalone library</p></td>
<td><p>Removed</p></td>
<td><p>There seemed no point to poorly replicating one of the many fine
terminal-massaging libraries out there (such as those listed in the
description of <a class="reference external" href="https://github.com/fabric/fabric/issues/101">#101</a>)
in the rewrite, so we didn’t.</p>
<p>That said, it seems highly plausible we’ll end up vendoring such a
library in the future to offer internal color support, at which point
“baked-in” color helpers would again be within easy reach.</p>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">char_buffered</span></code> context manager for forcing a local stream to be
character buffered</p></td>
<td><p>Ported</p></td>
<td><p>This is now <code class="xref py py-obj docutils literal notranslate"><span class="pre">character_buffered</span></code>.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">docs.unwrap_tasks</span></code> for extracting docstrings from wrapped task
functions</p></td>
<td><p>Ported</p></td>
<td><p>v1 required using a Fabric-specific ‘unwrap_tasks’ helper function
somewhere in your Sphinx build pipeline; now you can instead just
enable the new <a class="reference external" href="https://invocations.readthedocs.io/en/latest/api/autodoc.html">invocations.autodoc</a>
Sphinx mini-plugin in your extensions list; see link for details.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">network.normalize</span></code>, <code class="docutils literal notranslate"><span class="pre">denormalize</span></code> and <code class="docutils literal notranslate"><span class="pre">parse_host_string</span></code>,
ostensibly internals but sometimes exposed to users for dealing with
host strings</p></td>
<td><p>Removed</p></td>
<td><p>As with other host-string-related tools, these are gone and serve no
purpose. <code class="xref py py-obj docutils literal notranslate"><span class="pre">fabric.connection.Connection</span></code> is now the primary API focus
and has individual attributes for all “host string” components.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">utils.indent</span></code> for indenting/wrapping text (uncommonly used)</p></td>
<td><p>Pending</p></td>
<td><p>Not ported yet; ideally we’ll just vendor a third party lib in Invoke.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">reboot</span></code> for rebooting and reconnecting to a remote system</p></td>
<td><p>Removed</p></td>
<td><p>No equivalent has been written for modern Fabric; now that the
connection/client objects are made explicit, one can simply
instantiate a new object with the same parameters (potentially with
sufficient timeout parameters to get past the reboot, if one doesn’t
want to manually call something like <a class="reference external" href="https://docs.python.org/3/library/time.html#time.sleep" title="(在 Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">time.sleep</span></code></a>.)</p>
<p>There is a small chance it will return if there appears to be enough
need; if so, it’s likely to be a more generic reconnection related
<code class="xref py py-obj docutils literal notranslate"><span class="pre">fabric.connection.Connection</span></code> method, where the user is responsible
for issuing the restart shell command via <code class="docutils literal notranslate"><span class="pre">sudo</span></code> themselves.</p>
</td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">require</span></code> for ensuring certain key(s) in <code class="docutils literal notranslate"><span class="pre">env</span></code> have values set,
optionally by noting they can be <code class="docutils literal notranslate"><span class="pre">provided_by=</span></code> a list of setup tasks</p></td>
<td><p>Removed</p></td>
<td><p>This has not been ported, in part because the maintainers never used it
themselves, and is unlikely to be directly reimplemented. However, its
core use case of “require certain data to be available to run a given
task” may return within the upcoming dependency framework.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">prompt</span></code> for prompting the user &amp; storing the entered data
(optionally with validation) directly into <code class="docutils literal notranslate"><span class="pre">env</span></code></p></td>
<td><p>Removed</p></td>
<td><p>Like <code class="docutils literal notranslate"><span class="pre">require</span></code>, this seemed like a less-used feature (especially
compared to its sibling <code class="docutils literal notranslate"><span class="pre">confirm</span></code>) and was not ported. If it returns
it’s likely to be via <code class="docutils literal notranslate"><span class="pre">invocations</span></code>, which is where <code class="docutils literal notranslate"><span class="pre">confirm</span></code> ended
up.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="networking">
<span id="upgrading-networking"></span><h3><a class="toc-backref" href="#id16" role="doc-backlink">Networking</a><a class="headerlink" href="#networking" title="Permalink to this heading">¶</a></h3>
<table class="docutils align-default">
<colgroup>
<col style="width: 40%" />
<col style="width: 10%" />
<col style="width: 50%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">env.gateway</span></code> for setting an SSH jump gateway</p></td>
<td><p>Ported</p></td>
<td><p>This is now the <code class="docutils literal notranslate"><span class="pre">gateway</span></code> kwarg to <code class="xref py py-obj docutils literal notranslate"><span class="pre">fabric.connection.Connection</span></code>,
and – for the newly supported <code class="docutils literal notranslate"><span class="pre">ProxyJump</span></code> style gateways, which can
be nested indefinitely! – should be another
<code class="xref py py-obj docutils literal notranslate"><span class="pre">fabric.connection.Connection</span></code> object instead of a host string.</p>
<p>(You may specify a runtime, non-SSH-config-driven
<code class="docutils literal notranslate"><span class="pre">ProxyCommand</span></code>-style string as the <code class="docutils literal notranslate"><span class="pre">gateway</span></code> kwarg instead, which
will act just like a regular <code class="docutils literal notranslate"><span class="pre">ProxyCommand</span></code>.)</p>
</td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">ssh_config</span></code>-driven <code class="docutils literal notranslate"><span class="pre">ProxyCommand</span></code> support</p></td>
<td><p>Ported</p></td>
<td><p>This continues to work as it did in v1.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">remote_tunnel(...):</span></code> port forwarding</p></td>
<td><p>Ported</p></td>
<td><p>This is now <code class="xref py py-obj docutils literal notranslate"><span class="pre">fabric.connection.Connection.forward_local</span></code>, since it’s
used to <em>forward</em> a <em>local</em> port to the remote end. (Newly added is the
logical inverse, <code class="xref py py-obj docutils literal notranslate"><span class="pre">fabric.connection.Connection.forward_remote</span></code>.)</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">NetworkError</span></code> raised on some network related errors</p></td>
<td><p>Removed</p></td>
<td><p>In v1 this was simply a (partially implemented) stepping-back from the
original “just sys.exit on any error!” behavior. Modern Fabric is
significantly more exception-friendly; situations that would raise
<code class="docutils literal notranslate"><span class="pre">NetworkError</span></code> in v1 now simply become the real underlying
exceptions, typically from Paramiko or the stdlib.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">env.keepalive</span></code> for setting network keepalive value</p></td>
<td><p><a class="reference external" href="https://github.com/fabric/fabric/issues/1807">Pending</a></p></td>
<td><p>Not ported yet.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">env.connection_attempts</span></code> for setting connection retries</p></td>
<td><p><a class="reference external" href="https://github.com/fabric/fabric/issues/1808">Pending</a></p></td>
<td><p>Not ported yet.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">env.timeout</span></code> for controlling connection (and sometimes command
execution) timeout</p></td>
<td><p>Ported</p></td>
<td><p>Connection timeout is now controllable both via the configuration
system (as <code class="docutils literal notranslate"><span class="pre">timeouts.connect</span></code>) and a direct kwarg on
<code class="xref py py-obj docutils literal notranslate"><span class="pre">fabric.connection.Connection</span></code>. Command execution timeout is its own
setting now, <code class="docutils literal notranslate"><span class="pre">timeouts.command</span></code> and a <code class="docutils literal notranslate"><span class="pre">timeout</span></code> kwarg to <code class="docutils literal notranslate"><span class="pre">run</span></code>
and friends.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="authentication">
<h3><a class="toc-backref" href="#id17" role="doc-backlink">Authentication</a><a class="headerlink" href="#authentication" title="Permalink to this heading">¶</a></h3>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>Some <code class="docutils literal notranslate"><span class="pre">env</span></code> keys from v1 were simply passthroughs to Paramiko’s
<code class="xref py py-obj docutils literal notranslate"><span class="pre">SSHClient.connect</span></code> method. Modern
Fabric gives you explicit control over the arguments it passes to that
method, via the <code class="docutils literal notranslate"><span class="pre">connect_kwargs</span></code> <span class="xref std std-ref">configuration</span>
subtree, and the below table will frequently refer you to that approach.</p>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 40%" />
<col style="width: 10%" />
<col style="width: 50%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">env.key_filename</span></code></p></td>
<td><p>Ported</p></td>
<td><p>Use <code class="docutils literal notranslate"><span class="pre">connect_kwargs</span></code>.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">env.password</span></code></p></td>
<td><p>Ported</p></td>
<td><p>Use <code class="docutils literal notranslate"><span class="pre">connect_kwargs</span></code>.</p>
<p>Also note that this used to perform double duty as connection <em>and</em>
sudo password; the latter is now found in the <code class="docutils literal notranslate"><span class="pre">sudo.password</span></code>
setting.</p>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">env.gss_(auth|deleg|kex)</span></code></p></td>
<td><p>Ported</p></td>
<td><p>Use <code class="docutils literal notranslate"><span class="pre">connect_kwargs</span></code>.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">env.key</span></code>, a string or file object holding private key data, whose
specific type is auto-determined and instantiated for use as the
<code class="docutils literal notranslate"><span class="pre">pkey</span></code> connect kwarg</p></td>
<td><p>Removed</p></td>
<td><p>This has been dropped as unnecessary (&amp; bug-prone) obfuscation of
Paramiko-level APIs; users should already know which type of key
they’re dealing with and instantiate a <code class="docutils literal notranslate"><span class="pre">PKey</span></code> subclass themselves,
placing the result in <code class="docutils literal notranslate"><span class="pre">connect_kwargs.pkey</span></code>.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">env.no_agent</span></code>, which is a renaming/inversion of Paramiko’s
<code class="docutils literal notranslate"><span class="pre">allow_agent</span></code> connect kwarg</p></td>
<td><p>Ported</p></td>
<td><p>Users who were setting this to <code class="docutils literal notranslate"><span class="pre">True</span></code> should now simply set
<code class="docutils literal notranslate"><span class="pre">connect_kwargs.allow_agent</span></code> to <code class="docutils literal notranslate"><span class="pre">False</span></code> instead.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">env.no_keys</span></code>, similar to <code class="docutils literal notranslate"><span class="pre">no_agent</span></code>, just an inversion of the
<code class="docutils literal notranslate"><span class="pre">look_for_keys</span></code> connect kwarg</p></td>
<td><p>Ported</p></td>
<td><p>Use <code class="docutils literal notranslate"><span class="pre">connect_kwargs.look_for_keys</span></code> instead (setting it to <code class="docutils literal notranslate"><span class="pre">False</span></code>
to disable Paramiko’s default key-finding behavior.)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">env.passwords</span></code> (and <code class="docutils literal notranslate"><span class="pre">env.sudo_passwords</span></code>) stores connection/sudo
passwords in a dict keyed by host strings</p></td>
<td><p>Ported/<a class="reference external" href="https://github.com/fabric/fabric/issues/4">Pending</a></p></td>
<td><p>Each <code class="xref py py-obj docutils literal notranslate"><span class="pre">fabric.connection.Connection</span></code> object may be configured with its
own <code class="docutils literal notranslate"><span class="pre">connect_kwargs</span></code> given at instantiation time, allowing for
per-host password configuration already.</p>
<p>However, we expect users may want a simpler way to set configuration
values that are turned into implicit <code class="xref py py-obj docutils literal notranslate"><span class="pre">fabric.connection.Connection</span></code>
objects automatically; such a feature is still pending.</p>
</td>
</tr>
<tr class="row-even"><td><p>Configuring <code class="docutils literal notranslate"><span class="pre">IdentityFile</span></code> in one’s <code class="docutils literal notranslate"><span class="pre">ssh_config</span></code></p></td>
<td><p>Ported</p></td>
<td><p>Still honored, along with a bunch of newly honored <code class="docutils literal notranslate"><span class="pre">ssh_config</span></code>
settings; see <span class="xref std std-ref">ssh-config</span>.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="file-transfer">
<span id="upgrading-transfers"></span><h3><a class="toc-backref" href="#id18" role="doc-backlink">File transfer</a><a class="headerlink" href="#file-transfer" title="Permalink to this heading">¶</a></h3>
<p>The below feature breakdown applies to the <code class="docutils literal notranslate"><span class="pre">put</span></code> and/or <code class="docutils literal notranslate"><span class="pre">get</span></code> “operation”
functions from v1.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 40%" />
<col style="width: 10%" />
<col style="width: 50%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>Transferring individual files owned by the local and remote user</p></td>
<td><p>Ported</p></td>
<td><p>Basic file transfer in either direction works and is offered as
<code class="xref py py-obj docutils literal notranslate"><span class="pre">fabric.connection.Connection.get</span></code>/<code class="xref py py-obj docutils literal notranslate"><span class="pre">fabric.connection.Connection.put</span></code>
(though the code is split out into a separate-responsibility class,
<code class="xref py py-obj docutils literal notranslate"><span class="pre">fabric.transfer.Transfer</span></code>.)</p>
<p>The signature of these methods has been cleaned up compared to v1,
though their positional-argument essence (<code class="docutils literal notranslate"><span class="pre">get(remote,</span> <span class="pre">local)</span></code> and
<code class="docutils literal notranslate"><span class="pre">put(local,</span> <span class="pre">remote)</span></code> remains the same.</p>
</td>
</tr>
<tr class="row-even"><td><p>Omit the ‘destination’ argument for implicit ‘relative to local
context’ behavior (e.g. <code class="docutils literal notranslate"><span class="pre">put(&quot;local.txt&quot;)</span></code> implicitly uploading to
remote <code class="docutils literal notranslate"><span class="pre">$HOME/local.txt</span></code>.)</p></td>
<td><p>Ported</p></td>
<td><p>You should probably still be explicit, because this is Python.</p></td>
</tr>
<tr class="row-odd"><td><p>Use either file paths <em>or</em> file-like objects on either side of
the transfer operation (e.g. uploading a <code class="docutils literal notranslate"><span class="pre">StringIO</span></code> instead of an
on-disk file)</p></td>
<td><p>Ported</p></td>
<td><p>This was a useful enough and simple enough trick to keep around.</p></td>
</tr>
<tr class="row-even"><td><p>Preservation of source file mode at destination (e.g. ensuring an
executable bit that would otherwise be dropped by the destination’s
umask, is re-added.)</p></td>
<td><p>Ported</p></td>
<td><p>Not only was this ported, but it is now the default behavior. It may be
disabled via kwarg if desired.</p></td>
</tr>
<tr class="row-odd"><td><p>Bundled <code class="docutils literal notranslate"><span class="pre">sudo</span></code> operations as part of file transfer</p></td>
<td><p>Removed</p></td>
<td><p>This was one of the absolute buggiest parts of v1 and never truly did
anything users could not do themselves with a followup call to
<code class="docutils literal notranslate"><span class="pre">sudo</span></code>, so we opted not to port it.</p>
<p>Should enough users pine for its loss, we <em>may</em> reconsider, but if we
do it will be with a serious eye towards simplification and/or an
approach not involving intermediate files.</p>
</td>
</tr>
<tr class="row-even"><td><p>Recursive multi-file transfer (e.g. <code class="docutils literal notranslate"><span class="pre">put(a_directory)</span></code> uploads entire
directory and all its contents)</p></td>
<td><p>Removed</p></td>
<td><p>This was <em>another</em> one of the buggiest parts of v1, and over time it
became clear that its maintenance burden far outweighed the fact that
it was poorly reinventing <code class="docutils literal notranslate"><span class="pre">rsync</span></code> and/or the use of archival file
tools like ye olde <code class="docutils literal notranslate"><span class="pre">tar``+``gzip</span></code>.</p>
<p>For one potential workaround, see the <code class="docutils literal notranslate"><span class="pre">rsync</span></code> function in <a class="reference external" href="https://github.com/fabric/patchwork">patchwork</a>.</p>
</td>
</tr>
<tr class="row-odd"><td><p>Remote file path tilde expansion</p></td>
<td><p>Removed</p></td>
<td><p>This behavior is ultimately unnecessary (one can simply leave the
tilde off for the same result) and had a few pernicious bugs of its
own, so it’s gone.</p></td>
</tr>
<tr class="row-even"><td><p>Naming downloaded files after some aspect of the remote destination, to
avoid overwriting during multi-server actions</p></td>
<td><p>Ported</p></td>
<td><p>Added back (to <code class="xref py py-obj docutils literal notranslate"><span class="pre">fabric.transfer.Transfer.get</span></code>) in Fabric 2.6.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="configuration">
<span id="upgrading-configuration"></span><h3><a class="toc-backref" href="#id19" role="doc-backlink">Configuration</a><a class="headerlink" href="#configuration" title="Permalink to this heading">¶</a></h3>
<p>In general, configuration has been massively improved over the old <code class="docutils literal notranslate"><span class="pre">fabricrc</span></code>
files; most config logic comes from <span class="xref std std-ref">Invoke’s configuration system</span>, which offers a full-fledged configuration hierarchy (in-code
config, multiple config file locations, environment variables, CLI flags, and
more) and multiple file formats. Nearly all configuration avenues in Fabric 1
become, in modern Fabric, manipulation of whatever part of the config hierarchy
is most appropriate for your needs.</p>
<p>Modern versions of Fabric only make minor modifications to (or
parameterizations of) Invoke’s setup; see <span class="xref std std-ref">our locally-specific config doc
page</span> for details.</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>Make sure to look elsewhere in this document for details on any given v1
<code class="docutils literal notranslate"><span class="pre">env</span></code> setting, as many have moved outside the configuration system into
object or method keyword arguments.</p>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 40%" />
<col style="width: 10%" />
<col style="width: 50%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>Modifying <code class="docutils literal notranslate"><span class="pre">fabric.(api.)env</span></code> directly</p></td>
<td><p>Ported</p></td>
<td><p>To effect truly global-scale config changes, use config files,
task-collection-level config data, or the invoking shell’s environment
variables.</p></td>
</tr>
<tr class="row-even"><td><p>Making locally scoped <code class="docutils literal notranslate"><span class="pre">fabric.env</span></code> changes via <code class="docutils literal notranslate"><span class="pre">with</span>
<span class="pre">settings(...):</span></code> or its decorator equivalent, <code class="docutils literal notranslate"><span class="pre">&#64;with_settings</span></code></p></td>
<td><p>Ported/Pending</p></td>
<td><p>Most of the use cases surrounding <code class="docutils literal notranslate"><span class="pre">settings</span></code> are now served by
the fact that <code class="xref py py-obj docutils literal notranslate"><span class="pre">fabric.connection.Connection</span></code> objects keep
per-host/connection state - the pattern of switching the implicit
global context around was a design antipattern which is now gone.</p>
<p>The remaining such use cases have been turned into context-manager
methods of <code class="xref py py-obj docutils literal notranslate"><span class="pre">fabric.connection.Connection</span></code> (or its parent class), or
have such methods pending.</p>
</td>
</tr>
<tr class="row-odd"><td><p>SSH config file loading (off by default, limited to <code class="docutils literal notranslate"><span class="pre">~/.ssh/config</span></code>
only unless configured to a different, single path)</p></td>
<td><p>Ported</p></td>
<td><p>Much improved: SSH config file loading is <strong>on</strong> by default (which
<span class="xref std std-ref">can be changed</span>), multiple sources are
loaded and merged just like OpenSSH, and more besides; see
<span class="xref std std-ref">ssh-config</span>.</p>
<p>In addition, we’ve added support for some <code class="docutils literal notranslate"><span class="pre">ssh_config</span></code> directives
which were ignored by v1, such as <code class="docutils literal notranslate"><span class="pre">ConnectTimeout</span></code> and
<code class="docutils literal notranslate"><span class="pre">ProxyCommand</span></code>, and going forwards we intend to support as much of
<code class="docutils literal notranslate"><span class="pre">ssh_config</span></code> as is reasonably possible.</p>
</td>
</tr>
</tbody>
</table>
</section>
<section id="contrib">
<span id="upgrading-contrib"></span><h3><a class="toc-backref" href="#id20" role="doc-backlink"><code class="docutils literal notranslate"><span class="pre">contrib</span></code></a><a class="headerlink" href="#contrib" title="Permalink to this heading">¶</a></h3>
<p>The old <code class="docutils literal notranslate"><span class="pre">contrib</span></code> module represented “best practice” functions that did not,
themselves, require core support from the rest of Fabric but were built using
the same primitives available to users.</p>
<p>In modern Fabric, that responsibility has been removed from the core library
into other standalone libraries which have their own identity &amp; release
process, typically either <a class="reference external" href="https://github.com/pyinvoke/invocations">invocations</a> (local-oriented code that does not
use SSH) or <a class="reference external" href="https://github.com/fabric/patchwork">patchwork</a> (primarily
remote-oriented code, though anything not explicitly dealing with both ends of
the connection will work just as well locally.)</p>
<p>Those libraries are still a work in progress, not least because we still need
to identify the best way to bridge the gap between them (as many operations are
not intrinsically local-or-remote but can work on either end.)</p>
<p>Since they are by definition built on the core APIs available to all users,
they currently get less development focus; users can always implement their own
versions without sacrificing much (something less true for the core libraries.)
We expect to put more work into curating these collections once the core APIs
have settled down.</p>
<p>Details about what happened to each individual chunk of <code class="docutils literal notranslate"><span class="pre">fabric.contrib</span></code> are
in the below table:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 40%" />
<col style="width: 10%" />
<col style="width: 50%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">console.confirm</span></code> for easy bool-returning confirmation prompts</p></td>
<td><p>Ported</p></td>
<td><p>Moved to <code class="docutils literal notranslate"><span class="pre">invocations.console.confirm</span></code>, with minor signature tweaks.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">django.*</span></code>, supporting integration with a local Django project re:
importing and using Django models and other code</p></td>
<td><p>Removed</p></td>
<td><p>We aren’t even sure if this is useful a decade after it was written,
given how much Django has surely changed since then. If you’re reading
and are sad that this is gone, let us know!</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">files.*</span></code> (e.g. <code class="docutils literal notranslate"><span class="pre">exists</span></code>, <code class="docutils literal notranslate"><span class="pre">append</span></code>, <code class="docutils literal notranslate"><span class="pre">contains</span></code> etc) for
interrogating and modifying remote files</p></td>
<td><p>Ported/Pending</p></td>
<td><p>Many of the more useful functions in this file have been ported to
<code class="docutils literal notranslate"><span class="pre">patchwork.files</span></code> but are still in an essentially alpha state.</p>
<p>Others, such as <code class="docutils literal notranslate"><span class="pre">is_link</span></code>, <code class="docutils literal notranslate"><span class="pre">comment</span></code>/<code class="docutils literal notranslate"><span class="pre">uncomment</span></code>, etc have not
been ported yet. If they are, the are likely to end up in the same
place.</p>
</td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">project.rsync_project</span></code> for rsyncing the entire host project remotely</p></td>
<td><p>Ported</p></td>
<td><p>Now <code class="docutils literal notranslate"><span class="pre">patchwork.transfers.rsync</span></code>, with some modifications.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">project.rsync_project</span></code> for uploading host project via archive file
and scp</p></td>
<td><p>Removed</p></td>
<td><p>This did not seem worth porting; the overall pattern of “copy my local
bits remotely” is already arguably an antipattern (vs repeatable
deploys of artifacts, or at least remote checkout of a VCS tag) and if
one is going down that road anyways, rsync is a much smarter choice.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="fabric-env-reference">
<span id="upgrading-env"></span><h3><a class="toc-backref" href="#id21" role="doc-backlink"><code class="docutils literal notranslate"><span class="pre">fabric.env</span></code> reference</a><a class="headerlink" href="#fabric-env-reference" title="Permalink to this heading">¶</a></h3>
<p>Many/most of the members in v1’s <code class="docutils literal notranslate"><span class="pre">fabric.env</span></code> are covered in the above
per-topic sections; any that are <em>not</em> covered elsewhere, live here. All are
explicitly noted as <code class="docutils literal notranslate"><span class="pre">env.&lt;name&gt;</span></code> for ease of searching in your browser or
viewer.</p>
<p>A small handful of env vars were never publicly documented &amp; were thus
implicitly private; those are not represented here.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 40%" />
<col style="width: 10%" />
<col style="width: 50%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">env.abort_exception</span></code> for setting which exception is used to abort</p></td>
<td><p>Removed</p></td>
<td><p>Aborting as a concept is gone, just raise whatever exception seems most
reasonable to surface to an end user, or use <code class="xref py py-obj docutils literal notranslate"><span class="pre">Exit</span></code>.
See also <a class="reference internal" href="#upgrading-utility"><span class="std std-ref">Utilities</span></a>.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">env.all_hosts</span></code> and <code class="docutils literal notranslate"><span class="pre">env.tasks</span></code> listing execution targets</p></td>
<td><p>Ported/<a class="reference external" href="https://github.com/pyinvoke/invoke/issues/443">Pending</a></p></td>
<td><p>Fabric’s <code class="xref py py-obj docutils literal notranslate"><span class="pre">Executor</span></code> subclass stores references to all
CLI parsing results (including the value of <code class="xref std std-option docutils literal notranslate"><span class="pre">--hosts</span></code>, the
tasks requested and their args, etc) and the intent is for users to
have access to that information.</p>
<p>However, the details for that API (e.g. exposing the executor via a
task’s <code class="xref py py-obj docutils literal notranslate"><span class="pre">Context</span></code>/<code class="xref py py-obj docutils literal notranslate"><span class="pre">fabric.connection.Connection</span></code>) are
still in flux.</p>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">env.command</span></code> noting currently executing task name (in hindsight,
quite the misnomer…)</p></td>
<td><p>Ported/<a class="reference external" href="https://github.com/pyinvoke/invoke/issues/443">Pending</a></p></td>
<td><p>See the notes for <code class="docutils literal notranslate"><span class="pre">env.all_hosts</span></code> above - same applies here re: user
visibility into CLI parsing results.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">env.command_prefixes</span></code> for visibility into (arguably also mutation
of) the shell command prefixes to be applied to <code class="docutils literal notranslate"><span class="pre">run</span></code>/<code class="docutils literal notranslate"><span class="pre">sudo</span></code></p></td>
<td><p>Ported</p></td>
<td><p>This is now <code class="xref py py-obj docutils literal notranslate"><span class="pre">command_prefixes</span></code>.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">env.cwd</span></code> noting current intended working directory</p></td>
<td><p>Ported</p></td>
<td><p>This is now <code class="xref py py-obj docutils literal notranslate"><span class="pre">command_cwds</span></code> (a list, not a
single string, to more properly model the intended
contextmanager-driven use case.)</p>
<p>Note that remote-vs-local context for this data isn’t yet set up; see
the notes about <code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">cd</span></code> under <a class="reference internal" href="#upgrading-commands"><span class="std std-ref">Shell command execution (local/run/sudo)</span></a>.</p>
</td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">env.dedupe_hosts</span></code> controlling whether duplicate hosts in merged host
lists get deduplicated or not</p></td>
<td><p><a class="reference external" href="https://github.com/fabric/fabric/issues/1594">Pending</a></p></td>
<td><p>Not ported yet, will probably get tackled as part of roles/host lists
overhaul.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">env.echo_stdin</span></code> (undocumented) for turning off the default echoing
of standard input</p></td>
<td><p>Ported</p></td>
<td><p>Is now a config option under the <code class="docutils literal notranslate"><span class="pre">run</span></code> tree, with much the same
behavior.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">env.local_user</span></code> for read-only access to the discovered local
username</p></td>
<td><p>Removed</p></td>
<td><p>We’re not entirely sure why v1 felt this was worth caching in the
config; if you need this info, just import and call
<code class="xref py py-obj docutils literal notranslate"><span class="pre">fabric.util.get_local_user</span></code>.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">env.output_prefix</span></code> determining whether or not line-by-line
host-string prefixes are displayed</p></td>
<td><p><a class="reference external" href="https://github.com/pyinvoke/invoke/issues/15">Pending</a></p></td>
<td><p>Differentiating parallel stdout/err is still a work in progress; we may
end up reusing line-by-line logging and prefixing (ideally via actual
logging) or we may try for something cleaner such as streaming to
per-connection log files.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">env.prompts</span></code> controlling prompt auto-response</p></td>
<td><p>Ported</p></td>
<td><p>Prompt auto-response is now publicly implemented as the
<code class="xref py py-obj docutils literal notranslate"><span class="pre">StreamWatcher</span></code> and <code class="xref py py-obj docutils literal notranslate"><span class="pre">Responder</span></code> class
hierarchy, instances of which can be handed to <code class="docutils literal notranslate"><span class="pre">run</span></code> via kwarg or
stored globally in the config as <code class="docutils literal notranslate"><span class="pre">run.watchers</span></code>.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">env.real_fabfile</span></code> storing read-only fabfile path which was loaded by
the CLI machinery</p></td>
<td><p>Ported</p></td>
<td><p>The loaded task <code class="xref py py-obj docutils literal notranslate"><span class="pre">Collection</span></code> is stored on both the
top level <code class="xref py py-obj docutils literal notranslate"><span class="pre">Program</span></code> object as well as the
<code class="xref py py-obj docutils literal notranslate"><span class="pre">Executor</span></code> which calls tasks; and
<code class="xref py py-obj docutils literal notranslate"><span class="pre">Collection</span></code> has a <code class="docutils literal notranslate"><span class="pre">loaded_from</span></code> attribute with
this information.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">env.remote_interrupt</span></code> controlling how interrupts (i.e. a local
<a class="reference external" href="https://docs.python.org/3/library/exceptions.html#KeyboardInterrupt" title="(在 Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">KeyboardInterrupt</span></code></a> are caught, forwarded or other</p></td>
<td><p>Ported/Removed</p></td>
<td><p>Invoke’s interrupt capture behavior is currently “always just send the
interrupt character to the subprocess and continue”, allowing
subprocesses to handle <code class="docutils literal notranslate"><span class="pre">^C</span></code> however they need to, which is an
improvement over Fabric 1 and roughly equivalent to setting
<code class="docutils literal notranslate"><span class="pre">env.remote_interrupt</span> <span class="pre">=</span> <span class="pre">True</span></code>.</p>
<p>Allowing users to change this behavior via config is not yet
implemented, and may not be, depending on whether anybody needs it - it
was added as an option in v1 for backwards compat reasons.</p>
<p>It is also technically possible to change interrupt behavior by
subclassing and overriding <code class="xref py py-obj docutils literal notranslate"><span class="pre">invoke.runners.Runner.send_interrupt</span></code>.</p>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">env.roles</span></code>, <code class="docutils literal notranslate"><span class="pre">env.roledefs</span></code> and <code class="docutils literal notranslate"><span class="pre">env.effective_roles</span></code>
controlling/exposing what roles are available or currently in play</p></td>
<td><p><a class="reference external" href="https://github.com/fabric/fabric/issues/1594">Pending</a></p></td>
<td><p>As noted in <a class="reference internal" href="#upgrading-api"><span class="std std-ref">API organization</span></a>, roles as a concept were ported to
<code class="xref py py-obj docutils literal notranslate"><span class="pre">fabric.group.Group</span></code>, but there’s no central clearinghouse in which to
store them.</p>
<p>We <em>may</em> delegate this to userland forever, but seems likely a
common-best-practice option (such as creating <code class="xref py py-obj docutils literal notranslate"><span class="pre">Groups</span></code> from some configuration subtree and storing them
as a <code class="xref py py-obj docutils literal notranslate"><span class="pre">Context</span></code> attribute) will appear in early 2.x.</p>
</td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">env.ok_ret_codes</span></code> for overriding the default “0 good, non-0 bad”
error detection for subprocess commands</p></td>
<td><p><a class="reference external" href="https://github.com/pyinvoke/invoke/issues/541">Pending</a></p></td>
<td><p>Not ported yet, but should involve some presumably minor updates to
<code class="xref py py-obj docutils literal notranslate"><span class="pre">invoke.runners.Runner.generate_result</span></code> and <code class="xref py py-obj docutils literal notranslate"><span class="pre">Result</span></code>.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">env.sudo_prefix</span></code> determining the sudo binary name + its flags used
when creating <code class="docutils literal notranslate"><span class="pre">sudo</span></code> command strings</p></td>
<td><p><a class="reference external" href="https://github.com/pyinvoke/invoke/issues/540">Pending</a></p></td>
<td><p>Sudo command construction does not currently look at the config for
anything but the actual sudo prompt.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">env.sudo_prompt</span></code> for setting the prompt string handed to <code class="docutils literal notranslate"><span class="pre">sudo</span></code>
(and then expected in return for auto-replying with a configured
password)</p></td>
<td><p>Ported</p></td>
<td><p>Is now <code class="docutils literal notranslate"><span class="pre">sudo.prompt</span></code> in the configuration system.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">env.use_exceptions_for</span></code> to note which actions raise exceptions</p></td>
<td><p>Removed</p></td>
<td><p>As with most other functionality surrounding Fabric 1’s “jump straight
to <a class="reference external" href="https://docs.python.org/3/library/sys.html#sys.exit" title="(在 Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">sys.exit</span></code></a>” design antipattern, this is gone - modern Fabric will
not be hiding any exceptions from user-level code.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">env.use_ssh_config</span></code> to enable off-by-default SSH config loading</p></td>
<td><p>Ported</p></td>
<td><p>SSH config loading is now on by default, but an option remains to
disable it. See <a class="reference internal" href="#upgrading-configuration"><span class="std std-ref">Configuration</span></a> for more.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">env.version</span></code> exposing current Fabric version number</p></td>
<td><p>Removed</p></td>
<td><p>Just <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">fabric</span></code> and reference <code class="docutils literal notranslate"><span class="pre">fabric.__version__</span></code> (string) or
<code class="docutils literal notranslate"><span class="pre">fabric.__version_info__</span></code> (tuple).</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="example-upgrade-process">
<h2>Example upgrade process<a class="headerlink" href="#example-upgrade-process" title="Permalink to this heading">¶</a></h2>
<p>This section goes over upgrading a small but nontrivial Fabric 1 fabfile to
work with modern Fabric. It’s not meant to be exhaustive, merely illustrative;
for a full list of how to upgrade individual features or concepts, see
<a class="reference internal" href="#upgrade-specifics"><span class="std std-ref">Upgrade specifics</span></a>.</p>
<section id="sample-original-fabfile">
<h3>Sample original fabfile<a class="headerlink" href="#sample-original-fabfile" title="Permalink to this heading">¶</a></h3>
<p>Here’s a (slightly modified to concur with ‘modern’ Fabric 1 best practices)
copy of Fabric 1’s final tutorial snippet, which we will use as our test case
for upgrading:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">fabric.api</span> <span class="kn">import</span> <span class="n">abort</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">local</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">task</span>
<span class="kn">from</span> <span class="nn">fabric.contrib.console</span> <span class="kn">import</span> <span class="n">confirm</span>

<span class="n">env</span><span class="o">.</span><span class="n">hosts</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;my-server&quot;</span><span class="p">]</span>

<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">settings</span><span class="p">(</span><span class="n">warn_only</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">local</span><span class="p">(</span><span class="s2">&quot;./manage.py test my_app&quot;</span><span class="p">,</span> <span class="n">capture</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">failed</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">confirm</span><span class="p">(</span><span class="s2">&quot;Tests failed. Continue anyway?&quot;</span><span class="p">):</span>
        <span class="n">abort</span><span class="p">(</span><span class="s2">&quot;Aborting at user request.&quot;</span><span class="p">)</span>

<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">commit</span><span class="p">():</span>
    <span class="n">local</span><span class="p">(</span><span class="s2">&quot;git add -p &amp;&amp; git commit&quot;</span><span class="p">)</span>

<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">push</span><span class="p">():</span>
    <span class="n">local</span><span class="p">(</span><span class="s2">&quot;git push&quot;</span><span class="p">)</span>

<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">prepare_deploy</span><span class="p">():</span>
    <span class="n">test</span><span class="p">()</span>
    <span class="n">commit</span><span class="p">()</span>
    <span class="n">push</span><span class="p">()</span>

<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">deploy</span><span class="p">():</span>
    <span class="n">code_dir</span> <span class="o">=</span> <span class="s2">&quot;/srv/django/myproject&quot;</span>
    <span class="k">with</span> <span class="n">settings</span><span class="p">(</span><span class="n">warn_only</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">run</span><span class="p">(</span><span class="s2">&quot;test -d </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code_dir</span><span class="p">))</span><span class="o">.</span><span class="n">failed</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;git clone user@vcshost:/path/to/repo/.git </span><span class="si">{}</span><span class="s2">&quot;</span>
            <span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code_dir</span><span class="p">))</span>
    <span class="k">with</span> <span class="n">cd</span><span class="p">(</span><span class="n">code_dir</span><span class="p">):</span>
        <span class="n">run</span><span class="p">(</span><span class="s2">&quot;git pull&quot;</span><span class="p">)</span>
        <span class="n">run</span><span class="p">(</span><span class="s2">&quot;touch app.wsgi&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>We’ll port this directly, meaning the result will still be <code class="docutils literal notranslate"><span class="pre">fabfile.py</span></code>,
though we’d like to note that writing your code in a more library-oriented
fashion - even just as functions not wrapped in <code class="docutils literal notranslate"><span class="pre">&#64;task</span></code> - can make testing
and reusing code easier.</p>
</section>
<section id="imports">
<h3>Imports<a class="headerlink" href="#imports" title="Permalink to this heading">¶</a></h3>
<p>In modern Fabric, we don’t need to import nearly as many functions, due to the
emphasis on object methods instead of global functions. We only need the
following:</p>
<ul class="simple">
<li><p><code class="xref py py-obj docutils literal notranslate"><span class="pre">Exit</span></code>, a friendlier way of requesting a <a class="reference external" href="https://docs.python.org/3/library/sys.html#sys.exit" title="(在 Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">sys.exit</span></code></a>;</p></li>
<li><p><code class="xref py py-obj docutils literal notranslate"><span class="pre">&#64;task</span></code>, as before, but coming from Invoke as it’s not
SSH-specific;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">confirm</span></code>, which now comes from the Invocations library (also not
SSH-specific; though Invocations is one of the descendants of
<code class="docutils literal notranslate"><span class="pre">fabric.contrib</span></code>, which no longer exists);</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">fabric</span> <span class="kn">import</span> <span class="n">task</span>
<span class="kn">from</span> <span class="nn">invoke</span> <span class="kn">import</span> <span class="n">Exit</span>
<span class="kn">from</span> <span class="nn">invocations.console</span> <span class="kn">import</span> <span class="n">confirm</span>
</pre></div>
</div>
</section>
<section id="host-list">
<h3>Host list<a class="headerlink" href="#host-list" title="Permalink to this heading">¶</a></h3>
<p>The idea of a predefined <em>global</em> host list is gone; there is currently no
direct replacement. In general, users can set up their own execution context,
creating explicit <code class="xref py py-obj docutils literal notranslate"><span class="pre">fabric.connection.Connection</span></code> and/or <code class="xref py py-obj docutils literal notranslate"><span class="pre">fabric.group.Group</span></code>
objects as needed; core Fabric is in the process of building convenience
helpers on top of this, but “create your own Connections” will always be there
as a backstop.</p>
<p>Speaking of convenience helpers: most of the functionality of <code class="docutils literal notranslate"><span class="pre">fab</span> <span class="pre">--hosts</span></code>
and <code class="docutils literal notranslate"><span class="pre">&#64;hosts</span></code> has been ported over – the former directly (see
<code class="xref std std-option docutils literal notranslate"><span class="pre">--hosts</span></code>), the latter as a <code class="xref py py-obj docutils literal notranslate"><span class="pre">&#64;task</span></code> keyword
argument. Thus, for now our example will be turning the global <code class="docutils literal notranslate"><span class="pre">env.hosts</span></code>
into a lightweight module-level variable declaration, intended for use in the
subsequent calls to <code class="docutils literal notranslate"><span class="pre">&#64;task</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">my_hosts</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;my-server&quot;</span><span class="p">]</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>This is an area under active development, so feedback is welcomed.</p>
</div>
</section>
<section id="test-task">
<h3>Test task<a class="headerlink" href="#test-task" title="Permalink to this heading">¶</a></h3>
<p>The first task in the fabfile uses a good spread of the API. We’ll outline the
changes here (though again, all details are in <a class="reference internal" href="#upgrade-specifics"><span class="std std-ref">Upgrade specifics</span></a>):</p>
<ul class="simple">
<li><p>Declaring a function as a task is nearly the same as before: use a <code class="docutils literal notranslate"><span class="pre">&#64;task</span></code>
decorator (which, in modern Fabric, can take more optional keyword arguments
than its predecessor, including some which replace some of v1’s decorators).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&#64;task</span></code>-wrapped functions must now take an explicit initial context
argument, whose value will be a <code class="xref py py-obj docutils literal notranslate"><span class="pre">fabric.connection.Connection</span></code> object at
runtime.</p></li>
<li><p>The use of <code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">settings(warn_only=True)</span></code> can be replaced by a simple
kwarg to the <code class="docutils literal notranslate"><span class="pre">local</span></code> call.</p></li>
<li><p>That <code class="docutils literal notranslate"><span class="pre">local</span></code> call is now a method call on the
<code class="xref py py-obj docutils literal notranslate"><span class="pre">fabric.connection.Connection</span></code>, <code class="xref py py-obj docutils literal notranslate"><span class="pre">fabric.connection.Connection.local</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">capture</span></code> is no longer a useful argument; we can now capture and display at
the same time, locally or remotely. If you don’t actually <em>want</em> a local
subprocess to mirror its stdout/err while it runs, you can simply say
<code class="docutils literal notranslate"><span class="pre">hide=True</span></code> (or <code class="docutils literal notranslate"><span class="pre">hide=&quot;stdout&quot;</span></code> or etc.)</p></li>
<li><p>Result objects are pretty similar between versions; modern Fabric’s results
no longer pretend to “be” strings, but instead act more like booleans, acting
truthy if the command exited cleanly, and falsey otherwise. In terms of
attributes exhibited, most of the same info is available, and more besides.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">abort</span></code> is gone; you should use whatever exceptions you feel are
appropriate, or <code class="xref py py-obj docutils literal notranslate"><span class="pre">Exit</span></code> for a <a class="reference external" href="https://docs.python.org/3/library/sys.html#sys.exit" title="(在 Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">sys.exit</span></code></a> equivalent. (Or
just call <a class="reference external" href="https://docs.python.org/3/library/sys.html#sys.exit" title="(在 Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">sys.exit</span></code></a> if you want a no-questions-asked immediate exit that
even our CLI machinery won’t touch.)</p></li>
</ul>
<p>The result:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@task</span>
<span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">local</span><span class="p">(</span><span class="s2">&quot;./manage.py test my_app&quot;</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">confirm</span><span class="p">(</span><span class="s2">&quot;Tests failed. Continue anyway?&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">Exit</span><span class="p">(</span><span class="s2">&quot;Aborting at user request.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="other-simple-tasks">
<h3>Other simple tasks<a class="headerlink" href="#other-simple-tasks" title="Permalink to this heading">¶</a></h3>
<p>The next two tasks are simple one-liners, and you’ve already seen what replaced
the global <code class="docutils literal notranslate"><span class="pre">local</span></code> function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@task</span>
<span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
    <span class="n">c</span><span class="o">.</span><span class="n">local</span><span class="p">(</span><span class="s2">&quot;git add -p &amp;&amp; git commit&quot;</span><span class="p">)</span>

<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
    <span class="n">c</span><span class="o">.</span><span class="n">local</span><span class="p">(</span><span class="s2">&quot;git push&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="calling-tasks-from-other-tasks">
<h3>Calling tasks from other tasks<a class="headerlink" href="#calling-tasks-from-other-tasks" title="Permalink to this heading">¶</a></h3>
<p>This is another area that is in flux at the Invoke level, but for now, we can
simply call the other tasks as functions, just as was done in v1. The main
difference is that we want to pass along our context object to preserve the
configuration context (such as loaded config files or CLI flags):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@task</span>
<span class="k">def</span> <span class="nf">prepare_deploy</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
    <span class="n">test</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="n">commit</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="n">push</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="actual-remote-steps">
<h3>Actual remote steps<a class="headerlink" href="#actual-remote-steps" title="Permalink to this heading">¶</a></h3>
<p>Note that up to this point, nothing truly Fabric-related has been in play -
<code class="xref py py-obj docutils literal notranslate"><span class="pre">fabric.connection.Connection.local</span></code> is just a rebinding of <code class="xref py py-obj docutils literal notranslate"><span class="pre">Context.run</span></code>, Invoke’s local subprocess execution method. Now
we get to the actual deploy step, which invokes
<code class="xref py py-obj docutils literal notranslate"><span class="pre">fabric.connection.Connection.run</span></code> instead, executing remotely (on whichever
host the <code class="xref py py-obj docutils literal notranslate"><span class="pre">fabric.connection.Connection</span></code> has been bound to).</p>
<p><code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">cd</span></code> is not fully implemented for the remote side of things, but we
expect it will be soon. For now we fall back to command chaining with <code class="docutils literal notranslate"><span class="pre">&amp;&amp;</span></code>.
And, notably, now that we care about selecting host targets, we refer to our
earlier definition of a default host list – <code class="docutils literal notranslate"><span class="pre">my_hosts</span></code> – when declaring the
default host list for this task.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@task</span><span class="p">(</span><span class="n">hosts</span><span class="o">=</span><span class="n">my_hosts</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">deploy</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
    <span class="n">code_dir</span> <span class="o">=</span> <span class="s2">&quot;/srv/django/myproject&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;test -d </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code_dir</span><span class="p">),</span> <span class="n">warn</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;git clone user@vcshost:/path/to/repo/.git </span><span class="si">{}</span><span class="s2">&quot;</span>
        <span class="n">c</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code_dir</span><span class="p">))</span>
    <span class="n">c</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;cd </span><span class="si">{}</span><span class="s2"> &amp;&amp; git pull&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code_dir</span><span class="p">))</span>
    <span class="n">c</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;cd </span><span class="si">{}</span><span class="s2"> &amp;&amp; touch app.wsgi&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code_dir</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="the-whole-thing">
<h3>The whole thing<a class="headerlink" href="#the-whole-thing" title="Permalink to this heading">¶</a></h3>
<p>Now we have the entire, upgraded fabfile that will work with modern Fabric:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">invoke</span> <span class="kn">import</span> <span class="n">Exit</span>
<span class="kn">from</span> <span class="nn">invocations.console</span> <span class="kn">import</span> <span class="n">confirm</span>

<span class="kn">from</span> <span class="nn">fabric</span> <span class="kn">import</span> <span class="n">task</span>

<span class="n">my_hosts</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;my-server&quot;</span><span class="p">]</span>

<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">local</span><span class="p">(</span><span class="s2">&quot;./manage.py test my_app&quot;</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">confirm</span><span class="p">(</span><span class="s2">&quot;Tests failed. Continue anyway?&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">Exit</span><span class="p">(</span><span class="s2">&quot;Aborting at user request.&quot;</span><span class="p">)</span>

<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
    <span class="n">c</span><span class="o">.</span><span class="n">local</span><span class="p">(</span><span class="s2">&quot;git add -p &amp;&amp; git commit&quot;</span><span class="p">)</span>

<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
    <span class="n">c</span><span class="o">.</span><span class="n">local</span><span class="p">(</span><span class="s2">&quot;git push&quot;</span><span class="p">)</span>

<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">prepare_deploy</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
    <span class="n">test</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="n">commit</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="n">push</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

<span class="nd">@task</span><span class="p">(</span><span class="n">hosts</span><span class="o">=</span><span class="n">my_hosts</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">deploy</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
    <span class="n">code_dir</span> <span class="o">=</span> <span class="s2">&quot;/srv/django/myproject&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;test -d </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code_dir</span><span class="p">),</span> <span class="n">warn</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;git clone user@vcshost:/path/to/repo/.git </span><span class="si">{}</span><span class="s2">&quot;</span>
        <span class="n">c</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code_dir</span><span class="p">))</span>
    <span class="n">c</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;cd </span><span class="si">{}</span><span class="s2"> &amp;&amp; git pull&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code_dir</span><span class="p">))</span>
    <span class="n">c</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;cd </span><span class="si">{}</span><span class="s2"> &amp;&amp; touch app.wsgi&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code_dir</span><span class="p">))</span>
</pre></div>
</div>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="index.html">
    <img class="logo" src="_static/logo.png" alt="Logo"/>
    
    <h1 class="logo logo-name">Fabric</h1>
    
  </a>
</p>



<p class="blurb">Pythonic remote execution</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=fabric&repo=fabric&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>导航</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog-v1.html">Changelog (1.x)</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">FAQs</a></li>
<li class="toctree-l1"><a class="reference internal" href="installing.html">Installing</a></li>
<li class="toctree-l1"><a class="reference internal" href="installing-1.x.html">Installing (1.x)</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Upgrading from 1.x</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#why-upgrade">Why upgrade?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sidegrading-to-invoke">‘Sidegrading’ to Invoke</a></li>
<li class="toctree-l2"><a class="reference internal" href="#using-modern-fabric-from-within-invoke">Using modern Fabric from within Invoke</a></li>
<li class="toctree-l2"><a class="reference internal" href="#running-both-fabric-versions-simultaneously">Running both Fabric versions simultaneously</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#creating-connection-and-or-config-objects-from-v1-settings">Creating <code class="docutils literal notranslate"><span class="pre">Connection</span></code> and/or <code class="docutils literal notranslate"><span class="pre">Config</span></code> objects from v1 settings</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mapping-of-v1-env-vars-to-modern-api-members">Mapping of v1 <code class="docutils literal notranslate"><span class="pre">env</span></code> vars to modern API members</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#upgrade-specifics">Upgrade specifics</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#general-conceptual">General / conceptual</a></li>
<li class="toctree-l3"><a class="reference internal" href="#api-organization">API organization</a></li>
<li class="toctree-l3"><a class="reference internal" href="#task-functions-decorators">Task functions &amp; decorators</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cli-arguments-options-and-behavior">CLI arguments, options and behavior</a></li>
<li class="toctree-l3"><a class="reference internal" href="#shell-command-execution-local-run-sudo">Shell command execution (<code class="docutils literal notranslate"><span class="pre">local</span></code>/<code class="docutils literal notranslate"><span class="pre">run</span></code>/<code class="docutils literal notranslate"><span class="pre">sudo</span></code>)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#general">General</a></li>
<li class="toctree-l4"><a class="reference internal" href="#run"><code class="docutils literal notranslate"><span class="pre">run</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#sudo"><code class="docutils literal notranslate"><span class="pre">sudo</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#local"><code class="docutils literal notranslate"><span class="pre">local</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#open-shell"><code class="docutils literal notranslate"><span class="pre">open_shell</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#utilities">Utilities</a></li>
<li class="toctree-l3"><a class="reference internal" href="#networking">Networking</a></li>
<li class="toctree-l3"><a class="reference internal" href="#authentication">Authentication</a></li>
<li class="toctree-l3"><a class="reference internal" href="#file-transfer">File transfer</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configuration">Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#contrib"><code class="docutils literal notranslate"><span class="pre">contrib</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#fabric-env-reference"><code class="docutils literal notranslate"><span class="pre">fabric.env</span></code> reference</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#example-upgrade-process">Example upgrade process</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#sample-original-fabfile">Sample original fabfile</a></li>
<li class="toctree-l3"><a class="reference internal" href="#imports">Imports</a></li>
<li class="toctree-l3"><a class="reference internal" href="#host-list">Host list</a></li>
<li class="toctree-l3"><a class="reference internal" href="#test-task">Test task</a></li>
<li class="toctree-l3"><a class="reference internal" href="#other-simple-tasks">Other simple tasks</a></li>
<li class="toctree-l3"><a class="reference internal" href="#calling-tasks-from-other-tasks">Calling tasks from other tasks</a></li>
<li class="toctree-l3"><a class="reference internal" href="#actual-remote-steps">Actual remote steps</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-whole-thing">The whole thing</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="development.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="contact.html">Contact</a></li>
</ul>


<hr />
<ul>
    
    <li class="toctree-l1"><a href="https://docs.fabfile.org">API Docs</a></li>
    
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">快速搜索</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="转向" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>


<h3 class="donation">Donate/support</h3>







<p>
Professionally-supported Fabric is available with the
<a href="https://tidelift.com/subscription/pkg/pypi-fabric?utm_source=pypi-fabric&utm_medium=referral&utm_campaign=docs">Tidelift Subscription</a>.
</p>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022 Jeff Forcier.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/upgrading.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-18486793-1']);
      _gaq.push(['_setDomainName', 'none']);
      _gaq.push(['_setAllowLinker', true]);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
    
  </body>
</html>